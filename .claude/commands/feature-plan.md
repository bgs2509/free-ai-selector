---
allowed-tools: Read(*), Glob(*), Grep(*), Edit(**/*.md), Write(**/*.md)
description: Создать план реализации новой фичи в существующем проекте
---

# Команда: /feature-plan

> Запускает Архитектора для планирования фичи (режим FEATURE).

---

## Синтаксис

```bash
/feature-plan
```

---

## Описание

Команда `/feature-plan` создаёт план реализации новой функции
в существующем проекте. Учитывает текущую архитектуру и паттерны.

> **VERIFY BEFORE ACT**: Перед созданием файлов/директорий проверьте их
> существование (см. CLAUDE.md, раздел "Критические правила").

---

## Агент

**Архитектор** (`.claude/agents/architect.md`)

---

## Порядок чтения файлов

> **Принцип**: Сначала контекст ЦП, потом инструкции фреймворка.
> **Подробнее**: [docs/initialization.md](../../docs/initialization.md)

### Фаза 1: Контекст целевого проекта

| # | Файл | Условие | Зачем |
|---|------|---------|-------|
| 1 | `./CLAUDE.md` | Если существует | Специфика проекта |
| 2 | `./.pipeline-state.json` | Обязательно | Режим, этап, ворота |
| 3 | `./ai-docs/docs/prd/*.md` | Обязательно | Требования фичи |
| 4 | `./ai-docs/docs/architecture/*.md` | Обязательно | Существующая архитектура |
| 5 | `./services/` | Обязательно | Существующий код |

### Фаза 2: Предусловия

| Ворота | Проверка |
|--------|----------|
| `mode` | `.pipeline-state.json → mode == "FEATURE"` |
| `PRD_READY` | `.pipeline-state.json → gates.PRD_READY.passed == true` |
| `RESEARCH_DONE` | `.pipeline-state.json → gates.RESEARCH_DONE.passed == true` |

### Фаза 3: Инструкции фреймворка

| # | Файл | Зачем |
|---|------|-------|
| 6 | `.aidd/CLAUDE.md` | Правила фреймворка |
| 7 | `.aidd/workflow.md` | Процесс и ворота |
| 8 | `.aidd/.claude/commands/feature-plan.md` | Этот файл |
| 9 | `.aidd/.claude/agents/architect.md` | Инструкции роли |

### Фаза 4: База знаний

| # | Файл | Условие |
|---|------|---------|
| 10 | `.aidd/knowledge/architecture/*.md` | По необходимости |

---

## Режимы

Только **FEATURE** — для существующих проектов.

Для нового проекта используйте `/plan`.

---

## Предусловия

| Ворота | Требование |
|--------|------------|
| `PRD_READY` | FEATURE_PRD документ существует |
| `RESEARCH_DONE` | Код проанализирован |

### Алгоритм проверки

```
1. Проверить существование .pipeline-state.json
2. Если файл отсутствует:
   ❌ Пайплайн не инициализирован
   → Сначала выполните /idea
3. Проверить mode == "FEATURE"
4. Если mode != "FEATURE":
   ⚠️ Режим CREATE — используйте /plan вместо /feature-plan
5. Проверить gates.PRD_READY.passed == true
6. Если ворота не пройдены:
   ❌ Ворота PRD_READY не пройдены
   → Сначала выполните /idea
7. Проверить gates.RESEARCH_DONE.passed == true
8. Если ворота не пройдены:
   ❌ Ворота RESEARCH_DONE не пройдены
   → Сначала выполните /research
9. Продолжить выполнение
```

---

## Выходные артефакты (в целевом проекте)

| Артефакт | Путь |
|----------|------|
| План фичи | `ai-docs/docs/plans/{feature}-plan.md` |

---

## Качественные ворота

### PLAN_APPROVED

| Критерий | Описание |
|----------|----------|
| Интеграция | Точки интеграции определены |
| Изменения | Необходимые изменения описаны |
| Риски | Потенциальные риски учтены |
| **Утверждение** | План утверждён пользователем |

**ВАЖНО**: Требуется явное подтверждение от пользователя!

---

## Примеры использования

```bash
# После /research (для фичи)
/feature-plan
```

---

## Отличия от /plan

| Аспект | /plan (CREATE) | /feature-plan (FEATURE) |
|--------|----------------|-------------------------|
| Цель | Полная архитектура системы | План интеграции фичи |
| Артефакт | `architecture/{name}-plan.md` | `plans/{feature}-plan.md` |
| Фокус | Компоненты с нуля | Точки расширения |
| Изменения | Создание нового | Минимизация изменений |

---

## Шаблон плана фичи

План фичи должен содержать:

```markdown
# План фичи: {Название}

## 1. Обзор
- Краткое описание
- Связь с существующим функционалом

## 2. Анализ существующего кода
- Затронутые сервисы
- Точки интеграции
- Существующие зависимости

## 3. План изменений

### 3.1 Новые компоненты
| Компонент | Расположение | Описание |

### 3.2 Модификации существующего кода
| Файл | Изменение | Причина |

### 3.3 Новые зависимости
| Зависимость | Версия | Назначение |

## 4. API контракты (если есть)

## 5. Влияние на существующие тесты

## 6. План интеграции
| # | Шаг | Зависимости |

## 7. Риски и митигация
| Риск | Вероятность | Митигация |
```

---

## Интеграционные соображения

При создании плана фичи учитывать:

### 1. Минимизация изменений
```
✓ Добавить новый модуль
✗ Переписывать существующий модуль

✓ Расширить интерфейс
✗ Менять сигнатуры существующих методов

✓ Добавить новый эндпоинт
✗ Менять URL существующих эндпоинтов
```

### 2. Обратная совместимость
- Существующие API должны работать без изменений
- Новые поля должны быть опциональными
- Миграции БД должны быть обратимыми

### 3. Тестирование
- Существующие тесты не должны ломаться
- Новые тесты изолированы от старых
- Интеграционные тесты покрывают точки соединения

---

## Следующий шаг

После прохождения ворот `PLAN_APPROVED`:

```bash
/generate
```
