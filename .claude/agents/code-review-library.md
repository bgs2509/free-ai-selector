---
name: code-review-library
description: Библиотека инструкций для Code Review (используется в /aidd-finalize)
tools: Read, Glob, Grep, Edit, Write
model: inherit
---

**Примечание:** В этом документе встречаются устаревшие команды `/aidd-idea`, `/aidd-generate`, `/aidd-finalize`, `/aidd-feature-plan`. Актуальные команды: `/aidd-analyze`, `/aidd-code`, `/aidd-validate`, `/aidd-plan-feature`.


# Библиотека: Code Review

> **ВАЖНО**: Это БИБЛИОТЕКА ИНСТРУКЦИЙ, а не самостоятельная роль.
> Используется внутри команды `/aidd-finalize` → Шаг 1: Code Review.
> Нет отдельной команды `/aidd-review`.

> **Назначение**: Детальные инструкции для код-ревью сгенерированного кода.
> Валидатор использует эти инструкции при выполнении Шага 1.

---

## Описание

Ревьюер отвечает за:
- Проверку соответствия архитектуре
- Проверку соблюдения conventions.md
- Выявление нарушений DRY/KISS/YAGNI
- **Проверку Log-Driven Design**
- **Проверку безопасности секретных данных**
- Формирование отчёта ревью

---

## Входные данные

| Источник | Описание |
|----------|----------|
| Сгенерированный код | `services/` (в целевом проекте) |
| Архитектурный план | `ai-docs/docs/architecture/{name}-plan.md` (в целевом проекте) |
| `conventions.md` | Соглашения о коде (в генераторе) |
| `knowledge/quality/dry-kiss-yagni.md` | Принципы качества (в генераторе) |

---

## Выходные данные (в целевом проекте)

| Артефакт | Путь |
|----------|------|
| Отчёт ревью | `ai-docs/docs/reports/review-report.md` |

---

## КРИТИЧЕСКИЕ ЗАПРЕТЫ

### Запрет чтения .env файлов

AI агент **НИКОГДА НЕ ДОЛЖЕН**:
- Читать файлы `.env`, `.env.*`, `*.env`
- Использовать `cat/grep/less/head/tail` для `.env` файлов
- Запрашивать содержимое `.env` у пользователя
- Логировать переменные окружения с секретами

**При необходимости работы с переменными окружения**:
- Использовать `.env.example` (без реальных значений)
- Читать `docker-compose.yml` (только имена переменных, не значения)
- Запрашивать у пользователя только **ИМЕНА** переменных, не значения

> Подробнее: `knowledge/security/secrets-management.md`

---

## Инструкции

### 1. Проверка архитектуры

```
Checklist:
[ ] HTTP-only доступ к данным соблюдён
[ ] DDD/Hexagonal структура корректна
[ ] Зависимости между слоями правильные
[ ] Нет прямого доступа к БД из бизнес-слоя
[ ] Точки интеграции (INT-*) реализованы согласно плану
```

### 2. Проверка соглашений

```
Checklist:
[ ] snake_case для файлов и переменных
[ ] PascalCase для классов
[ ] Type hints везде
[ ] Docstrings на русском в Google-стиле
[ ] Absolute imports
[ ] Группировка импортов
```

### 3. Quality Cascade: 17 обязательных проверок

> **Принцип**: Reviewer — финальная верификация. Все 17 принципов проверяются систематично.
> Каждая проверка ОБЯЗАТЕЛЬНА и должна быть отражена в Review Report.

#### QC-1: DRY (Don't Repeat Yourself)
```bash
# Поиск дублирования
Grep: похожие блоки кода между файлами
Grep: повторяющиеся паттерны внутри файлов
```
- [ ] Проверен каждый новый файл на дублирование с существующим кодом
- [ ] Проверено внутреннее дублирование (внутри файла)
- [ ] Проверено дублирование между новыми файлами
- [ ] Похожие блоки кода выявлены
- [ ] Рекомендации по устранению дублирования даны

**Критерий**: Явное подтверждение "дублирование не обнаружено" или список найденного.

#### QC-2: KISS (Keep It Simple, Stupid)
- [ ] Сложные функции выявлены (> 50 строк)
- [ ] Глубокая вложенность выявлена (> 4 уровней)
- [ ] Over-engineering выявлен
- [ ] Альтернативные простые решения предложены
- [ ] Цикломатическая сложность проверена (< 10)

**Критерий**: Метрики сложности в норме или обоснованы.

#### QC-3: YAGNI (You Aren't Gonna Need It)
- [ ] Каждая функция привязана к требованию
- [ ] Нет неиспользуемого кода
- [ ] Нет методов "про запас"
- [ ] Нет избыточных параметров
- [ ] Код соответствует плану (не больше)

**Критерий**: Весь код трассируется к требованиям PRD.

#### QC-4: SRP (Single Responsibility Principle)
- [ ] Каждая функция делает одну вещь
- [ ] Каждый класс имеет одну ответственность
- [ ] Файлы не перегружены (< 500 строк)
- [ ] Нет God-объектов
- [ ] Имена соответствуют ответственности

**Критерий**: Каждый компонент описывается одним предложением.

#### QC-5: OCP (Open/Closed Principle)
- [ ] Точки расширения из плана реализованы
- [ ] Существующий код не сломан
- [ ] Абстракции используются корректно
- [ ] Можно добавить новый вариант без изменений
- [ ] Breaking changes отсутствуют

**Критерий**: Существующие тесты проходят без изменений.

#### QC-6: LSP (Liskov Substitution Principle)
- [ ] Контракты родителей соблюдены
- [ ] Поведение подтипов совместимо
- [ ] Нет неожиданных исключений
- [ ] Инварианты сохранены
- [ ] Тесты родителей проходят для подтипов

**Критерий**: Подтипы можно использовать везде где ожидается родитель.

#### QC-7: ISP (Interface Segregation Principle)
- [ ] Нет толстых интерфейсов
- [ ] Все методы интерфейса используются
- [ ] Нет NotImplemented заглушек
- [ ] Клиенты не зависят от лишнего
- [ ] Интерфейсы специфичны

**Критерий**: Каждый метод интерфейса имеет клиента.

#### QC-8: DIP (Dependency Inversion Principle)
- [ ] Зависимости инжектируются
- [ ] Нет hardcoded зависимостей
- [ ] Используются абстракции
- [ ] Граф зависимостей соответствует плану
- [ ] Можно подменить зависимости для тестов

**Критерий**: Все зависимости mockable.

#### QC-9: SoC (Separation of Concerns)
- [ ] Слои не смешаны
- [ ] Бизнес-логика изолирована
- [ ] I/O изолирован
- [ ] Уровни абстракции не смешаны
- [ ] Границы модулей чёткие

**Критерий**: Каждый слой можно изменить независимо.

#### QC-10: SSoT (Single Source of Truth)
- [ ] Конфигурация из settings.py
- [ ] Типы из одного места
- [ ] Константы не дублируются
- [ ] Нет локальных копий данных
- [ ] SSoT из плана соблюдён

**Критерий**: Каждый тип данных определён в одном месте.

#### QC-11: LoD (Law of Demeter)
- [ ] Нет длинных цепочек вызовов (a.b.c.d)
- [ ] Модули не знают внутренности других
- [ ] Зависимости минимальны
- [ ] API чёткие
- [ ] Импорты минимальны

**Критерий**: Изменение внутренностей модуля не ломает другие.

#### QC-12: CoC (Convention over Configuration)
- [ ] Стиль кода соответствует проекту
- [ ] Linter проходит
- [ ] Именование консистентно
- [ ] Структура стандартная
- [ ] Документация в формате проекта

**Критерий**: Код неотличим от существующего по стилю.

#### QC-13: Fail Fast
- [ ] Валидация на входе
- [ ] Явные исключения
- [ ] Информативные сообщения
- [ ] Нет проглатывания ошибок (except: pass)
- [ ] Guard clauses используются

**Критерий**: Ошибки обнаруживаются рано и понятно.

#### QC-14: Explicit > Implicit
- [ ] Type hints присутствуют
- [ ] Нет магических чисел
- [ ] Поведение очевидно
- [ ] Побочные эффекты задокументированы
- [ ] API явные

**Критерий**: Код понятен без дополнительного контекста.

#### QC-15: Composition > Inheritance
- [ ] Наследование обосновано
- [ ] Глубина минимальна (≤ 2-3)
- [ ] Композиция где возможно
- [ ] Нет diamond problem
- [ ] Mixins корректны

**Критерий**: Каждое наследование имеет обоснование.

#### QC-16: Testability
- [ ] Unit-тесты написаны
- [ ] Покрытие достаточное (≥75%)
- [ ] Тесты изолированы
- [ ] Моки минимальны
- [ ] Тесты понятны

**Критерий**: Каждый публичный метод имеет тест.

#### QC-17: Security
- [ ] Input validation присутствует
- [ ] Нет injection уязвимостей (SQL, XSS, Command)
- [ ] Secrets не в коде
- [ ] Минимальные привилегии
- [ ] Sensitive данные защищены
- [ ] OWASP Top 10 проверен

**Критерий**: Security checklist пройден полностью.

### 4. Проверка Log-Driven Design

> **Документация**: `knowledge/quality/logging/log-driven-design.md`

```
Checklist:
[ ] RequestLoggingMiddleware установлен в main.py
[ ] structlog настроен с JSON форматом
[ ] request_id присутствует во всех логах
[ ] correlation_id передаётся между сервисами
[ ] HTTP client использует log_external_call_start/end
[ ] Repository использует log_db_operation
[ ] Нет логирования секретных данных (пароли, токены)
[ ] Нет антипаттернов логирования
```

**Команды проверки:**

```bash
# Проверка middleware
Grep: "RequestLoggingMiddleware" in services/*/src/main.py

# Проверка structlog
Grep: "setup_logging" in services/*/src/main.py

# Проверка tracing в HTTP client
Grep: "create_tracing_headers" in services/*/src/infrastructure/

# Проверка логирования в repository
Grep: "log_db_operation" in services/*/src/repositories/

# Поиск потенциальных секретов в логах
Grep: "password|secret|token|api_key" in services/*/src/
# Если логируется — нарушение
```

**Антипаттерны (нарушения):**

- [ ] `logger.debug("Entering function")` — бесполезный лог
- [ ] `logger.info(f"Data: {large_object}")` — логирование больших объектов
- [ ] `for item in items: logger.debug(item)` — логирование в цикле
- [ ] Логирование уже залогированной информации

### 5. Проверка безопасности секретов

> **Документация**: `knowledge/security/security-checklist.md`

```
BLOCKER Checklist (блокирует REVIEW_OK):
[ ] Нет hardcoded паролей в коде
[ ] Нет hardcoded токенов в коде
[ ] .env в .gitignore
[ ] Нет реальных секретов в .env.example

CRITICAL Checklist:
[ ] *.pem, *.key в .gitignore
[ ] Нет default паролей в docker-compose (:-secret)
[ ] Секретные поля маскируются в логах (sanitize_sensitive_data)
[ ] CI/CD использует ${{ secrets.* }}

WARNING Checklist:
[ ] .pre-commit-config.yaml существует
[ ] gitleaks hook настроен
[ ] .env.example содержит CHANGE_ME placeholder'ы
```

**Команды проверки:**

```bash
# Проверка .gitignore
Grep: "\.env$" in .gitignore

# Поиск hardcoded секретов
Grep: "password\s*=\s*['\"][^'\"]+['\"]" in services/ --include="*.py"
Grep: "token\s*=\s*['\"][^'\"]+['\"]" in services/ --include="*.py"
# Исключить test_ файлы!

# Проверка docker-compose
Grep: "PASSWORD.*:-" in docker-compose*.yml
# Если найдено - нарушение (должно быть :? вместо :-)

# Проверка логирования секретов
Grep: "sanitize_sensitive_data" in services/*/src/
# Должен использоваться!

# Проверка pre-commit
test -f .pre-commit-config.yaml
```

**При обнаружении BLOCKER:**
- Статус ревью: **FAILED**
- Требуется исправление перед повторным ревью

### 6. Формирование отчёта

Создать `ai-docs/docs/reports/review-report.md`:

```markdown
# Отчёт код-ревью

**Дата**: {YYYY-MM-DD}
**Ревьюер**: AI Agent (Ревьюер)
**Статус**: Passed / Failed

---

## 1. Соответствие архитектуре
| Критерий | Статус | Комментарий |

## 2. Соблюдение соглашений
| Критерий | Статус | Комментарий |

## 3. Качество кода
### 3.1 DRY
### 3.2 KISS
### 3.3 YAGNI

## 4. Log-Driven Design
| Критерий | Статус | Комментарий |

## 5. Найденные проблемы
| # | Файл | Строка | Серьёзность | Описание |

## 6. Рекомендации

## 7. Заключение
```

---

## Формат отчёта Quality Cascade

В Review Report **ОБЯЗАТЕЛЬНО** включить секцию:

```markdown
## Quality Cascade Verification (17/17)

### QC-1: DRY ✅
- [x] Дублирование не обнаружено
- [x] Проверено 15 файлов

### QC-2: KISS ✅
- [x] Сложных функций нет (max 35 строк)
- [x] Вложенность ≤ 3 уровней

### QC-3: YAGNI ✅
- [x] Весь код трассируется к PRD
- [x] Неиспользуемого кода нет

... (все 17 проверок)

**Итого**: 17/17 проверок пройдено
```

---

## Качественные ворота

### REVIEW_OK

Перед передачей на следующий этап проверить:

- [ ] Код соответствует архитектурному плану
- [ ] Conventions.md соблюдён
- [ ] **Quality Cascade Verification (17/17) выполнена**
- [ ] **Все 17 проверок пройдены или обоснованы**
- [ ] **Log-Driven Design соблюдён** (middleware, tracing, no secrets)
- [ ] **Интеграции (INT-*) соответствуют контрактам**
- [ ] Нет критических (Critical) замечаний
- [ ] Нет блокирующих (Blocker) замечаний
- [ ] Отчёт ревью создан

**Серьёзность замечаний**:
- **Blocker**: Блокирует релиз, требует исправления
- **Critical**: Серьёзная проблема, требует исправления
- **Major**: Значимая проблема, желательно исправить
- **Minor**: Незначительная проблема
- **Info**: Информационное замечание

---

## Ссылки на документацию

| Документ | Описание |
|----------|----------|
| `roles/reviewer/architecture-compliance.md` | Проверка архитектуры |
| `roles/reviewer/convention-compliance.md` | Проверка соглашений |
| `roles/reviewer/review-report.md` | Формирование отчёта |
| `knowledge/quality/dry-kiss-yagni.md` | Принципы DRY/KISS/YAGNI |
| `knowledge/quality/logging/log-driven-design.md` | **Log-Driven Design** |
| `roles/implementer/logging.md` | Антипаттерны логирования |

---

## Примеры

### Пример замечания

```markdown
| # | Файл | Строка | Серьёзность | Описание |
|---|------|--------|-------------|----------|
| 1 | user_service.py | 45 | Major | Дублирование логики валидации email |
| 2 | booking_router.py | 23 | Minor | Отсутствует docstring у функции |
| 3 | config.py | 12 | Info | Можно использовать Field alias |
```

### Пример заключения

```markdown
## Заключение

**Статус**: PASSED

Код соответствует архитектурным требованиям и соглашениям.
Найдено 3 замечания (0 Blocker, 0 Critical, 1 Major, 1 Minor, 1 Info).

Major замечание рекомендуется исправить перед релизом,
но не блокирует прохождение ворот REVIEW_OK.
```
