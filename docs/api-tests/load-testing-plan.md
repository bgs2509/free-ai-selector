# План нагрузочного тестирования (Locust)

**Дата**: 2026-02-25
**Инструмент**: Locust (Python)
**Цель**: Найти точку деградации, замерить latency и success rate под нагрузкой

---

## Сценарии тестирования

### Сценарий 1: Baseline
- **Endpoint**: POST `/api/v1/prompts/process`
- **Промпты**: Разной длины — короткие (~50 символов) и длинные (~2000 символов)
- **Цель**: Замер baseline latency и success rate при минимальной нагрузке (1 пользователь)

### Сценарий 2: Ramp-up (поиск точки отказа)
- **Endpoint**: POST `/api/v1/prompts/process`
- **Метод**: Постепенное увеличение пользователей начиная с малых значений
- **Цель**: Определить при какой нагрузке начинаются отказы, как быстро деградирует система
- **Анализ**: Когда начались отказы, как долго продолжались, восстановилась ли система

### Сценарий 3: Sustained load (10 минут)
- **Endpoint**: POST `/api/v1/prompts/process`
- **Длительность**: 10 минут при фиксированной нагрузке
- **Цель**: Проверка каскадного отказа (как в прогоне 2026-02-24: error rate 5% → 100%)

### Сценарий 4: Provider failover
- **Endpoint**: POST `/api/v1/prompts/process`
- **Условия**: Тестировать как есть — часть провайдеров уже мертвы (8 из 13 по отчёту)
- **Цель**: Замер overhead перебора мёртвых провайдеров

### ~~Сценарий 5: Data API stress~~ — ОТМЕНЁН
- Не требуется, Data API тестируется косвенно через Business API

---

## Отменённые варианты

| Вопрос | Отклонённый вариант | Выбранный вариант |
|--------|---------------------|-------------------|
| Промпты | Фиксированный / из файла | Разной длины (короткие + длинные) |
| Ramp-up цель | 100 RPS | До отказов (adaptive) |
| Sustained длительность | 30 минут | 10 минут |
| Мёртвые провайдеры | Деактивировать вручную | Как есть (естественное состояние) |
| Data API отдельно | Отдельный стресс-тест | Не нужен |

---

## Дополнительные endpoints (мониторинг во время теста)

| Endpoint | Назначение |
|----------|-----------|
| GET `/health` | Проверка здоровья Business API |
| GET `/api/v1/models/stats` | Статистика моделей (reliability scores) |

---

## Метрики для анализа

- **Response time**: p50, p95, p99
- **Success rate**: % успешных запросов
- **RPS**: Requests per second (фактический)
- **Failure rate**: % ошибок и типы ошибок (500, 422, timeout)
- **Точка деградации**: При скольких пользователях error rate > 10%
- **Время восстановления**: Восстанавливается ли система после снижения нагрузки
