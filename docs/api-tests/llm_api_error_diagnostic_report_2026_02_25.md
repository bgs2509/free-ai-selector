# Отчёт по ошибкам LLM API (full_async_live)

- Сформирован: 2026-02-25 07:09:15 
- Источник: `data/06_history/llm_reclassification/full_async_live/results.jsonl`
- Summary: `data/06_history/llm_reclassification/full_async_live/summary.json`

## 1) Краткое резюме

- Всего запросов: **3686**
- Успешно: **1250** (33.91%)
- Ошибки: **2436** (66.09%)
- Оценка длительности прогона: **3:45:38.145088** (старт ~ 2026-02-24 20:16:05, завершение 2026-02-25 00:01:43)

## 2) Причины ошибок (все категории)

| Причина | Кол-во | Доля от всех ошибок | Первый индекс | Последний индекс |
|---|---:|---:|---:|---:|
| `HTTP 500` | 2296 | 94.25% | 386 | 3686 |
| `HTTP 422` | 139 | 5.71% | 140 | 829 |
| `Unexpected error: Remote end closed connection without response` | 1 | 0.04% | 3409 | 3409 |

Наблюдения:
- `HTTP 422` появляется рано и заканчивается на индексе 829 (локализованная фаза).
- `HTTP 500` начинается с индекса 386 и доминирует до конца прогона.
- Есть единичный сетевой сбой `Remote end closed connection without response`.

## 3) Тайминг ошибок (по фазам прогона)

Важное ограничение: в текущем `results.jsonl` нет пер-запросных timestamp. Ниже тайминг оценён по индексу (приближённо).

| Индексы | Окно времени (оценка) | OK | Error | Error % | HTTP 500 | HTTP 422 | Other |
|---|---|---:|---:|---:|---:|---:|---:|
| 1-200 | 2026-02-24 20:16:08  -> 2026-02-24 20:28:19  | 190 | 10 | 5.00% | 0 | 10 | 0 |
| 201-400 | 2026-02-24 20:28:23  -> 2026-02-24 20:40:34  | 188 | 12 | 6.00% | 2 | 10 | 0 |
| 401-600 | 2026-02-24 20:40:37  -> 2026-02-24 20:52:48  | 102 | 98 | 49.00% | 1 | 97 | 0 |
| 601-800 | 2026-02-24 20:52:52  -> 2026-02-24 21:05:03  | 157 | 43 | 21.50% | 26 | 17 | 0 |
| 801-1000 | 2026-02-24 21:05:06  -> 2026-02-24 21:17:17  | 121 | 79 | 39.50% | 74 | 5 | 0 |
| 1001-1200 | 2026-02-24 21:17:21  -> 2026-02-24 21:29:32  | 107 | 93 | 46.50% | 93 | 0 | 0 |
| 1201-1400 | 2026-02-24 21:29:36  -> 2026-02-24 21:41:46  | 93 | 107 | 53.50% | 107 | 0 | 0 |
| 1401-1600 | 2026-02-24 21:41:50  -> 2026-02-24 21:54:01  | 74 | 126 | 63.00% | 126 | 0 | 0 |
| 1601-1800 | 2026-02-24 21:54:05  -> 2026-02-24 22:06:16  | 63 | 137 | 68.50% | 137 | 0 | 0 |
| 1801-2000 | 2026-02-24 22:06:19  -> 2026-02-24 22:18:30  | 45 | 155 | 77.50% | 155 | 0 | 0 |
| 2001-2200 | 2026-02-24 22:18:34  -> 2026-02-24 22:30:45  | 31 | 169 | 84.50% | 169 | 0 | 0 |
| 2201-2400 | 2026-02-24 22:30:48  -> 2026-02-24 22:42:59  | 19 | 181 | 90.50% | 181 | 0 | 0 |
| 2401-2600 | 2026-02-24 22:43:03  -> 2026-02-24 22:55:14  | 18 | 182 | 91.00% | 182 | 0 | 0 |
| 2601-2800 | 2026-02-24 22:55:18  -> 2026-02-24 23:07:28  | 17 | 183 | 91.50% | 183 | 0 | 0 |
| 2801-3000 | 2026-02-24 23:07:32  -> 2026-02-24 23:19:43  | 8 | 192 | 96.00% | 192 | 0 | 0 |
| 3001-3200 | 2026-02-24 23:19:47  -> 2026-02-24 23:31:58  | 15 | 185 | 92.50% | 185 | 0 | 0 |
| 3201-3400 | 2026-02-24 23:32:01  -> 2026-02-24 23:44:12  | 1 | 199 | 99.50% | 199 | 0 | 0 |
| 3401-3600 | 2026-02-24 23:44:16  -> 2026-02-24 23:56:27  | 1 | 199 | 99.50% | 198 | 0 | 1 |
| 3601-3686 | 2026-02-24 23:56:30  -> 2026-02-25 00:01:43  | 0 | 86 | 100.00% | 86 | 0 | 0 |

- Самая длинная непрерывная серия ошибок: **266** (индексы 3202-3467, оценочно 2026-02-24 23:32:05 -> 2026-02-24 23:48:18).

## 4) Анализ причин по типам

### 4.1 HTTP 422 (validation/request issues)

- Всего: **139**
- Первый/последний индекс: **140 / 829**
- Наиболее вероятная причина: слишком большой payload запроса (длинные `short_answer/full_answer`).

Проверка длины payload (question + trimmed short + trimmed full):
- `HTTP 422`: count=139, mean=7282.7, median=7288.0, p95=7447, max=7505
- `OK`: count=1250, mean=4023.8, median=3396.5, p95=6588, max=7025
- `HTTP 422` с payload >= 7000: **139/139 (100%)**
- `OK` с payload >= 7000: **2/1250 (0.16%)**

Топ батчи с `HTTP 422`:
| Batch | HTTP 422 | Total | OK |
|---|---:|---:|---:|
| `batch_004_data_structures` | 104 | 362 | 245 |
| `batch_003_python_basics` | 20 | 304 | 284 |
| `batch_015_libs` | 6 | 42 | 28 |
| `batch_005_oop` | 5 | 63 | 50 |
| `batch_013_devops` | 2 | 5 | 3 |
| `batch_006_sql_db` | 1 | 12 | 11 |
| `batch_008_testing` | 1 | 9 | 8 |

### 4.2 HTTP 500 (server-side instability/capacity)

- Всего: **2296**
- Первый/последний индекс: **386 / 3686**
- После индекса ~1000 доля `HTTP 500` резко растёт и остаётся доминирующей до конца.

Топ батчи с `HTTP 500`:
| Batch | HTTP 500 | Total | OK | Error rate |
|---|---:|---:|---:|---:|
| `batch_004_data_structures` | 13 | 362 | 245 | 32.32% |
| `batch_100_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_114_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_136_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_154_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_160_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_161_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_162_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_163_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_169_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_176_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_180_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_184_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_188_easyoffer` | 10 | 10 | 0 | 100.00% |
| `batch_194_easyoffer` | 10 | 10 | 0 | 100.00% |

### 4.3 Прочие ошибки

- `['Unexpected error: Remote end closed connection without response']`
- Единичный сетевой сбой не влияет на общую картину.

## 5) Модели LLM, провайдеры и метаданные

- В текущем пайплайне **не логируются**: `model_id/model_name`, provider, latency per request, HTTP status per attempt, timestamp per request.
- Поэтому ответ на вопрос "какая модель давала ошибки" по текущим данным **невозможен**.

Что нужно добавить в логирование для следующего прогона:
1. `request_started_at`, `request_finished_at`, `duration_ms`.
2. `model_id`, `model_name`, `provider` (из ответа API, если есть).
3. `http_status`, `attempt`, `retry_delay_sec` для каждой попытки.
4. `prompt_chars` и оценку `prompt_tokens`.

## 6) Что видно по успешным 1250 (контекст для рефакторинга)

- Успешных с warnings: **746/1250 (59.68%)**
- Топ предупреждений (часто указывают на несогласованность справочников/форматов):
| Warning | Count |
|---|---:|
| `professions: добавлен обязательный код 'fullstack_dev'.` | 616 |
| `professions: удалён неизвестный код 'data_engineer'.` | 164 |
| `professions: добавлен обязательный код 'python_dev'.` | 161 |
| `answer_format: принудительно выставлен 'comparison'` | 60 |
| `answer_format: удалён неизвестный код 'text'.` | 60 |
| `professions: добавлен обязательный код 'backend_dev'.` | 33 |
| `professions: удалён неизвестный код 'js_dev'.` | 11 |
| `knowledge_areas: удалён неизвестный код 'web_development'.` | 9 |
| `knowledge_areas: после фильтра weight > 0.5 значений не осталось.` | 7 |
| `professions: удалён неизвестный код 'qa'.` | 5 |

## 7) Рекомендации по рефакторингу LLM API-клиента (приоритет)

### P0 (критично, чтобы убрать массовые ошибки)
1. Ввести **жёсткий budget payload** до отправки (например, `max_full_answer_chars` снизить до 4500-5500, `max_short_answer_chars` до 1200-1500) + адаптивное ужатие при `HTTP 422`.
2. На `HTTP 422` делать **fallback-режим**: сократить контекст и повторить 1 раз (с отдельным полем `fallback_used=true`).
3. На `HTTP 500` добавить **адаптивное снижение concurrency** (например, 8 -> 4 -> 2 при росте 5xx).
4. Включить **circuit breaker**: если 5xx-rate за окно > X%, пауза 30-60 сек и постепенное восстановление.

### P1 (наблюдаемость и диагностика)
1. Логировать per-request timestamps/model/provider/attempts/status/duration.
2. Сохранять полный API envelope (без секретов), не только `response.classification`.
3. Добавить отчёт post-run с timeline по минутам и метриками retry.

### P2 (качество результата)
1. Нормализовать справочники (`data_engineer`, `text`, `web_development` и т.д.), чтобы снизить warnings.
2. Добавить failover по моделям: primary -> secondary при серии 5xx.
3. Рассмотреть раздельные запросы: сначала scalar-классификаторы, затем list-поля для длинных кейсов.

## 8) Заключение

- Основной фактор срыва прогона: **массовый `HTTP 500` после ~индекса 386**, особенно после ~1000.
- `HTTP 422` сосредоточен в ранней фазе и **сильно коррелирует с длинным payload**.
- Без добавления model/timestamp telemetry невозможно точно разложить ошибки по конкретным моделям и времени ответа.
