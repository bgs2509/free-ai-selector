---
feature_id: "F020"
feature_name: "web-model-selection-stage1"
title: "Web UI: выбор конкретной AI модели (Stage 1)"
created: "2026-02-13"
author: "AI (Analyst)"
type: "prd"
status: "Draft"
version: 1
mode: "FEATURE"

related_features: [F002, F011-C, F019]
services: [free-ai-selector-business-api]
requirements_count: 14

pipelines:
  business: true
  data: true
  integration: true
  modified: [web-ui-interaction]
---

# PRD: Web UI — выбор конкретной AI модели (Stage 1)

**Feature ID**: F020  
**Версия**: 1.0  
**Дата**: 2026-02-13  
**Автор**: AI Agent (Аналитик)  
**Статус**: Draft

---

## 1. Обзор

### 1.1 Проблема
Backend уже поддерживает `model_id` в `POST /api/v1/prompts/process`, но Web UI не даёт выбрать конкретную модель.  
Пользователь в браузере может работать только в авто-режиме.

### 1.2 Решение
Добавить в Web UI режим выбора модели:
- `Авто` (по умолчанию, текущее поведение);
- `Конкретная` (выбор из списка и отправка `model_id`).

Список моделей для ручного выбора должен включать только “достаточно надёжные” модели.

### 1.3 Scope
**In scope (Stage 1):**
- только Web UI (`services/free-ai-selector-business-api/app/static/index.html`);
- выбор модели на уровне текущего запроса;
- загрузка списка моделей из API;
- отправка `model_id` в payload.

**Out of scope:**
- Telegram bot (отдельная будущая задача);
- персистентные пользовательские настройки (отдельная Stage 2 задача);
- изменения Business API/Data API контрактов.

---

## 2. Функциональные требования

### 2.1 Core Features (Must Have)

| ID | Название | Описание | Критерий приёмки |
|---|---|---|---|
| FR-001 | Режим выбора модели | В форме чата есть переключатель `Авто/Конкретная` | `Авто` выбран по умолчанию |
| FR-002 | Список моделей | В режиме `Конкретная` доступен выпадающий список только моделей с высоким `reliability_score` | Список загружается из `/api/v1/models/stats` и включает только модели с `is_active=true` и `reliability_score > 0.4`; каждая опция показывает score числом, например: `Llama... (Groq) — score: 0.90` |
| FR-003 | Передача model_id | При выборе `Конкретная` в запрос отправляется `model_id` | `POST /api/v1/prompts/process` получает `model_id > 0` |
| FR-004 | Авто-режим без изменений | В режиме `Авто` поле `model_id` не отправляется | Текущее поведение полностью сохраняется |
| FR-005 | Валидация выбора | Нельзя отправить `Конкретная` без выбранной модели | Показывается понятная ошибка в UI |
| FR-006 | Пустой список/ошибка загрузки | Пустой список или ошибка не должны блокировать пользователя | UI показывает ошибку и автоматически переключается в режим `Авто` |
| FR-007 | Совместимость с advanced params | `system_prompt` и `response_format` продолжают работать | Payload корректно содержит комбинацию полей |
| FR-008 | Fallback backend | При падении выбранной модели backend делает fallback как в F019 | Пользователь получает ответ либо штатную ошибку backend |

### 2.2 Important Features (Should Have)

| ID | Название | Описание | Критерий приёмки |
|---|---|---|---|
| FR-010 | Сортировка списка | Модели в списке отсортированы по reliability_score | Более высокий score отображается выше |
| FR-011 | Ручное обновление списка | Кнопка обновления списка моделей в UI | Повторный запрос в `/api/v1/models/stats` |
| FR-012 | Ясная подсказка | Текст-подсказка о поведении при сбоях ручного режима | Пользователь видит, что при проблеме UI вернётся в `Авто` |

### 2.3 Nice to Have (Could Have)

| ID | Название | Описание | Критерий приёмки |
|---|---|---|---|
| FR-020 | Показ “запрошенной модели” | Отдельно показывать, какую модель запрашивал пользователь | Метка в UI ответа (необязательно в Stage 1) |

---

## 3. User Stories

### US-001: Разовый выбор модели
Как пользователь Web UI, я хочу выбрать конкретную модель для одного запроса, чтобы проверить ответ нужного провайдера.

### US-002: Безопасный возврат в авто
Как пользователь Web UI, я хочу, чтобы при проблеме списка моделей интерфейс сам возвращался в `Авто`, чтобы не терять возможность отправить запрос.

### US-003: Видеть надёжность модели
Как пользователь Web UI, я хочу видеть числовой `reliability_score` рядом с каждой моделью, чтобы выбирать осознанно.

---

## 4. Пайплайны

### 4.1 Бизнес-пайплайн
`User input -> UI mode (auto/manual) -> models fetch/filter -> payload build -> /prompts/process -> backend selection/fallback -> UI response`

### 4.2 Data pipeline
- `GET /api/v1/models/stats` для списка моделей;
- клиентская фильтрация: `is_active=true` и `reliability_score > 0.4`;
- `POST /api/v1/prompts/process` для выполнения запроса.

### 4.3 Интеграционный пайплайн

| ID | От | К | Endpoint | Изменение |
|---|---|---|---|---|
| INT-001 | Browser | Business API | `GET /api/v1/models/stats` | Используется для model selector + score |
| INT-002 | Browser | Business API | `POST /api/v1/prompts/process` | Опционально добавляется `model_id` |

### 4.4 Влияние на существующие пайплайны
- Web UI: modify.
- Business API: без изменений контракта.
- Data API: без изменений.
- Telegram: без изменений (отдельная будущая задача).

---

## 5. UI/UX требования

| ID | Название | Описание | Приоритет |
|---|---|---|---|
| UI-001 | Размещение контролов | Селектор модели в блоке чата рядом с advanced params | Must |
| UI-002 | Дефолтный режим | По умолчанию `Авто` | Must |
| UI-003 | Автовозврат в `Авто` | При пустом списке или ошибке UI сам переключает `Авто` | Must |
| UI-004 | Отображение score | В каждой опции списка показывать `reliability_score` в числовом формате | Must |
| UI-005 | Mobile корректность | На узких экранах элементы не ломают верстку | Must |
| UI-006 | Тексты ошибок | Ошибки короткие и понятные на русском | Must |

---

## 6. Нефункциональные требования

| ID | Метрика | Требование |
|---|---|---|
| NF-001 | Производительность UI | Доп. задержка только при загрузке списка моделей |
| NF-002 | Обратная совместимость | Сценарий без выбора модели работает как ранее |
| NF-003 | Надёжность UX | Ошибка загрузки списка не блокирует отправку: UI уходит в `Авто` |
| NF-004 | Безопасность | Не логировать чувствительные данные, только технические поля |

### 6.5 Требования к тестированию

#### Smoke тесты (обязательно)
- TRQ-001: `Авто` режим отправляет запрос без `model_id`.
- TRQ-002: `Конкретная` режим отправляет валидный `model_id`.
- TRQ-003: список ручного выбора содержит только `is_active=true` и `reliability_score > 0.4`.
- TRQ-004: в каждой опции модели отображается score числом (пример `0.90`).
- TRQ-005: при пустом списке UI показывает ошибку и переключается в `Авто`.
- TRQ-006: при ошибке запроса `/api/v1/models/stats` UI показывает ошибку и переключается в `Авто`.
- TRQ-007: `system_prompt` и `response_format` корректно работают вместе с manual/auto режимом.

#### Unit/Integration/E2E
- Необязательны в рамках Stage 1 (по вашему правилу “без лишних тестов”).
- Достаточно smoke-проверок вручную.

---

## 7. Технические ограничения
- Без новых зависимостей.
- Изменения только в Web UI.
- Telegram и user settings не затрагивать.

---

## 8. Допущения и риски

| Риск | Вероятность | Влияние | Митигация |
|---|---|---|---|
| После фильтра `>0.4` список иногда пуст | Medium | Medium | Автопереключение в `Авто` + сообщение |
| Score быстро меняется | Medium | Low | Кнопка refresh списка |
| Пользователь ожидает фиксированный manual | Medium | Low | Явно показывать переход в `Авто` при ошибке |

---

## 9. Открытые вопросы
1. Формат округления score в UI: `0.9` или `0.90` (рекомендация: `0.90`).
2. Нужно ли визуально помечать, что запрос ушёл в `Авто` после авто-переключения.

---

## 10. Глоссарий
- `model_id`: идентификатор модели в системе.
- `auto mode`: выбор модели по reliability score.
- `manual mode`: приоритет выбранной пользователем модели.
- `reliability_score`: текущая метрика надёжности модели.

---

## 11. История изменений
- v1.0 (2026-02-13): первоначальный Draft.
- v1.1 (2026-02-13): добавлен фильтр `reliability_score > 0.4`, обязательный показ score в списке, авто-переключение в `Авто` при пустом списке/ошибке.
