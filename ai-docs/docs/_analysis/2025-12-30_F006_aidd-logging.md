---
feature_id: "F006"
feature_name: "aidd-logging"
title: "Приведение логирования к стандартам AIDD Framework"
created: "2025-12-30"
author: "AI (Analyst)"
type: "_analysis"
status: "PRD_READY"
version: 1
mode: "FEATURE"
services: ["free-ai-selector-business-api", "free-ai-selector-data-postgres-api", "free-ai-selector-telegram-bot", "free-ai-selector-health-worker"]
requirements_count: 18
---

# PRD: Приведение логирования к стандартам AIDD Framework (F006)

**Feature ID**: F006
**Версия**: 1.0
**Дата**: 2025-12-30
**Автор**: AI Agent (Аналитик)
**Статус**: PRD_READY

---

## 1. Обзор

### 1.1 Проблема

Текущее логирование в проекте free-ai-selector не соответствует стандартам AIDD Framework:

| Проблема | Влияние |
|----------|---------|
| Стандартный `logging` вместо `structlog` | Ручное формирование JSON, нет ContextVars |
| Отсутствует `correlation_id` | Невозможно трассировать запрос через все сервисы |
| Нет `log_decision()` | AI-агент не понимает ПОЧЕМУ выбран провайдер |
| Нет `duration_ms` | Отсутствуют метрики производительности |
| Нет стандартных `error_code` | Нет классификации ошибок |
| TG Bot/Health Worker без tracing | Запросы не трассируются |

### 1.2 Решение

Полная миграция на structlog с реализацией принципов Log-Driven Design:

1. **structlog** — структурированное логирование с процессорами
2. **Сквозная трассировка** — request_id, correlation_id, user_id
3. **ContextVars** — автоматическое включение контекста в логи
4. **log_decision()** — логирование решений с evaluated_conditions
5. **duration_ms** — метрики производительности для всех операций
6. **error_code** — стандартные коды ошибок

### 1.3 Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| Разработчики | Команда проекта | Понимание поведения системы, отладка |
| AI-агенты | Claude Code | Понимание ЧТО и ПОЧЕМУ произошло |
| DevOps | Операционная команда | Мониторинг, алертинг |

### 1.4 Ценностное предложение

- AI-агент сможет понять поведение системы по логам
- Полная трассировка запросов через все 4 сервиса
- Стандартизированный формат для парсинга и анализа

---

## 2. Функциональные требования

### 2.1 Core Features (Must Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-001 | structlog конфигурация | Заменить `logging.basicConfig` на `structlog.configure` во всех сервисах | Все 4 сервиса используют structlog |
| FR-002 | JSON формат | Production логи в JSON, development — консоль с цветами | `LOG_FORMAT=json/console` работает |
| FR-003 | request_id middleware | Генерация/передача request_id через `X-Request-ID` | request_id в каждом логе API сервисов |
| FR-004 | correlation_id | Передача correlation_id между сервисами (`X-Correlation-ID`) | correlation_id сохраняется через цепочку вызовов |
| FR-005 | ContextVars интеграция | Автоматическое добавление ID в логи через contextvars | Не нужно передавать ID явно в каждый `logger.info()` |
| FR-006 | Logger модуль | Создать `app/utils/logger.py` с конфигурацией в каждом сервисе | Единая точка настройки логирования |

### 2.2 Important Features (Should Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-010 | log_decision() | Хелпер для логирования решений (выбор модели, fallback) | decision, reason, evaluated_conditions в логах |
| FR-011 | duration_ms | Добавить duration_ms к request_completed и операциям | duration_ms присутствует в логах |
| FR-012 | error_code | Стандартные коды ошибок (VALIDATION_ERROR, etc.) | error_code в логах ошибок |
| FR-013 | TG Bot tracing | Добавить correlation_id в Telegram Bot | Запросы от бота трассируются |
| FR-014 | Health Worker tracing | Добавить job_id для health check циклов | Каждый цикл проверок идентифицирован |

### 2.3 Nice to Have (Could Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-020 | user_id автоматически | user_id из telegram в ContextVars | user_id в логах бота автоматически |
| FR-021 | path_params извлечение | Извлекать path params из роутинга FastAPI | path_params в request_started |
| FR-022 | rate_limit логирование | Логировать rate_limit из заголовков | rate_limit_remaining в логах |

---

## 3. User Stories

### US-001: Трассировка запроса через сервисы

**Как** разработчик
**Я хочу** видеть correlation_id во всех логах цепочки вызовов
**Чтобы** легко находить все связанные события при отладке

**Критерии приёмки:**
- [ ] TG Bot генерирует correlation_id при получении сообщения
- [ ] correlation_id передаётся в Business API через X-Correlation-ID
- [ ] Business API передаёт correlation_id в Data API
- [ ] Все логи содержат одинаковый correlation_id

**Связанные требования:** FR-004, FR-013

---

### US-002: Понимание выбора AI модели

**Как** AI-агент (Claude Code)
**Я хочу** видеть причины выбора конкретной AI модели
**Чтобы** понимать логику системы и диагностировать проблемы

**Критерии приёмки:**
- [ ] При выборе модели логируется decision=SELECT
- [ ] Логируются evaluated_conditions (active, available, etc.)
- [ ] Логируется reliability_score выбранной модели
- [ ] При fallback логируется decision=FALLBACK с причиной

**Связанные требования:** FR-010

---

### US-003: Мониторинг производительности

**Как** DevOps инженер
**Я хочу** видеть duration_ms для всех операций
**Чтобы** выявлять медленные запросы и оптимизировать систему

**Критерии приёмки:**
- [ ] request_completed содержит duration_ms
- [ ] Вызовы к AI провайдерам содержат duration_ms
- [ ] Вызовы к Data API содержат duration_ms

**Связанные требования:** FR-011

---

## 4. Нефункциональные требования

### 4.1 Производительность

| ID | Метрика | Требование | Измерение |
|----|---------|------------|-----------|
| NF-001 | Overhead логирования | < 1ms на запрос | Benchmark перед/после |
| NF-002 | Память | Не увеличивать потребление > 10MB | Docker stats |

### 4.2 Совместимость

| ID | Требование | Описание |
|----|------------|----------|
| NF-010 | Обратная совместимость | Существующие grep-паттерны должны работать |
| NF-011 | Сохранение полей | timestamp, level, service, message остаются |

### 4.3 Безопасность

| ID | Требование | Описание |
|----|------------|----------|
| NF-020 | Sanitization | Сохранить `sanitize_error_message()` для API ключей |
| NF-021 | Sensitive data | Не логировать пароли, токены, PII |

### 4.4 Конфигурируемость

| ID | Требование | Описание |
|----|------------|----------|
| NF-030 | LOG_LEVEL | Через env переменную |
| NF-031 | LOG_FORMAT | json (production) / console (development) |

---

## 5. Технические ограничения

### 5.1 Обязательные технологии

- **structlog** >= 24.0.0
- Python 3.11+
- Совместимость с существующим JSON форматом

### 5.2 Интеграции

| Система | Тип интеграции | Описание |
|---------|---------------|----------|
| Business API | HTTP Client | Передача X-Correlation-ID |
| Data API | HTTP Server | Приём X-Correlation-ID |
| TG Bot | HTTP Client | Генерация correlation_id |
| Health Worker | Standalone | Генерация job_id |

### 5.3 Ограничения

- Не использовать centralized logging (ELK) — MVP Level 2
- Не добавлять causation_id в этой итерации

---

## 6. Допущения и риски

### 6.1 Допущения

| # | Допущение | Влияние если неверно |
|---|-----------|---------------------|
| 1 | structlog совместим с FastAPI lifespan | Переписать конфигурацию |
| 2 | ContextVars работают с asyncio | Искать альтернативу |

### 6.2 Риски

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | Несовместимость форматов | Low | Medium | Тестирование grep-паттернов |
| 2 | Увеличение latency | Low | Medium | Benchmark до/после |

---

## 7. Открытые вопросы

| # | Вопрос | Статус | Ответственный | Решение |
|---|--------|--------|--------------|---------|
| 1 | Где разместить shared модули? | Resolved | User | В каждом сервисе: `app/utils/` |
| 2 | Нужен ли causation_id? | Resolved | User | Отложить на следующую итерацию |

---

## 8. Глоссарий

| Термин | Определение |
|--------|-------------|
| request_id | Уникальный ID текущей операции в сервисе |
| correlation_id | ID изначального запроса, не меняется между сервисами |
| causation_id | ID события-причины (не в этой итерации) |
| structlog | Библиотека структурированного логирования для Python |
| ContextVars | Контекстные переменные Python для async кода |
| Log-Driven Design | Подход, где логи — первичный источник информации |

---

## 9. История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2025-12-30 | AI Analyst | Первоначальная версия |

---

## Качественные ворота

### PRD_READY Checklist

- [x] Все секции заполнены
- [x] Требования имеют уникальные ID (FR-*, NF-*)
- [x] Критерии приёмки определены для каждого требования
- [x] User stories связаны с требованиями
- [x] Нет блокирующих открытых вопросов
- [x] Риски идентифицированы и имеют план митигации
