---
feature_id: "F013"
feature_name: "ai-providers-consolidation"
title: "Консолидация AI провайдеров: OpenAICompatibleProvider"
created: "2026-01-30"
author: "AI (Analyst)"
type: "prd"
status: "PRD_READY"
version: 1
mode: "FEATURE"

related_features: [F011-A, F011-B]
services: [free-ai-selector-business-api]
requirements_count: 6

pipelines:
  business: false
  data: false
  integration: false
  modified: [ai_providers]
---

# PRD: Консолидация AI провайдеров (OpenAICompatibleProvider)

**Feature ID**: F013
**Версия**: 1.0
**Дата**: 2026-01-30
**Автор**: AI Agent (Аналитик)
**Статус**: PRD_READY
**Тип**: Рефакторинг (Quality Cascade QC-1/DRY, QC-15/Composition)

---

## 1. Обзор

### 1.1 Проблема

В проекте обнаружено **~1,100 строк дублированного кода** в 11 AI провайдерах:

```
services/free-ai-selector-business-api/app/infrastructure/ai_providers/
├── groq.py          (143 строки) ─┐
├── cerebras.py      (144 строки)  │
├── sambanova.py     (143 строки)  │
├── deepseek.py      (143 строки)  │ 11 провайдеров с 95%
├── openrouter.py    (146 строк)   │ идентичным кодом
├── hyperbolic.py    (143 строки)  │
├── huggingface.py   (156 строк)   │
├── github_models.py (148 строк)   │
├── fireworks.py     (143 строки)  │
├── novita.py        (145 строк)   │
├── kluster.py       (143 строки)  │
└── scaleway.py      (144 строки) ─┘
```

**Дублируемая логика в каждом провайдере:**
- `generate()` метод: ~75 строк (OpenAI-compatible API call)
- `health_check()` метод: ~23 строки
- Валидация API key в `__init__`
- Headers formation
- Payload building
- Response parsing

**Проблемы:**
- Нарушение DRY → трудно поддерживать
- При добавлении новой функции (F011-B) требовалось менять 14 файлов
- Потенциал для расхождения реализаций
- ~1,540 строк вместо ~200 (экономия 87%)

### 1.2 Решение

Создать базовый класс `OpenAICompatibleProvider` в `base.py`, который:
1. Содержит всю общую логику (generate, health_check)
2. Параметризован через конфигурацию (base_url, model, headers_builder)
3. Позволяет провайдерам быть ~10 строк конфигурации

**После рефакторинга:**
```python
# groq.py — ~10 строк вместо 143
class GroqProvider(OpenAICompatibleProvider):
    PROVIDER_NAME = "groq"
    BASE_URL = "https://api.groq.com/openai/v1/chat/completions"
    DEFAULT_MODEL = "llama-3.1-70b-versatile"
    API_KEY_ENV = "GROQ_API_KEY"
```

### 1.3 Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| Разработчики | Те кто поддерживает код | DRY, единая точка изменений |
| AI Ops | Те кто добавляет провайдеров | Простое добавление нового провайдера |

### 1.4 Ценностное предложение

- **87% сокращение кода**: 1,540 строк → ~200 строк
- **Single Point of Change**: изменения в одном месте
- **Добавление нового провайдера**: ~10 строк вместо 143

---

## 2. Функциональные требования

### 2.1 Core Features (Must Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-001 | OpenAICompatibleProvider класс | Создать базовый класс с полной реализацией generate() и health_check() | Класс существует в base.py, содержит методы |
| FR-002 | Конфигурация провайдеров | Вынести различия в class attributes (PROVIDER_NAME, BASE_URL, DEFAULT_MODEL, API_KEY_ENV) | Каждый провайдер содержит только атрибуты |
| FR-004 | API key валидация | Перенести валидацию API key из generate() в __init__ | ProviderError при отсутствии ключа при инициализации |
| FR-005 | HTTP error wrapping | Обернуть httpx.HTTPError в ProviderError | Все HTTP ошибки конвертируются в ProviderError |
| FR-006 | Сохранить Cloudflare | Cloudflare НЕ трогать (не OpenAI-compatible) | cloudflare.py без изменений |

### 2.2 Important Features (Should Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-010 | Hook методы | Добавить _build_headers(), _build_payload() для кастомизации | Методы можно переопределить в наследниках |
| FR-011 | Типизация | Полные type hints для всех методов | mypy проходит без ошибок |

### 2.3 Nice to Have (Could Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-020 | Docstrings | Google-style docstrings на русском | Все публичные методы задокументированы |

---

## 3. User Stories

### US-001: Разработчик добавляет новый провайдер

**Как** разработчик
**Я хочу** добавить нового OpenAI-compatible провайдера за 2 минуты
**Чтобы** не дублировать 140 строк boilerplate кода

**Критерии приёмки:**
- [ ] Новый провайдер = ~10 строк кода
- [ ] Наследует от OpenAICompatibleProvider
- [ ] Определяет только конфигурационные атрибуты

**Связанные требования:** FR-001, FR-002

---

### US-002: Разработчик исправляет баг в API call

**Как** разработчик
**Я хочу** исправить баг в одном месте
**Чтобы** изменение применилось ко всем 11 провайдерам

**Критерии приёмки:**
- [ ] Общая логика в OpenAICompatibleProvider
- [ ] Изменение в base.py влияет на всех наследников

**Связанные требования:** FR-001, FR-003

---

## 4. Пайплайны

### 4.0 Тип изменений

| Параметр | Значение |
|----------|----------|
| Режим | FEATURE (рефакторинг) |
| Затрагиваемые пайплайны | ai_providers (infrastructure layer) |

### 4.1 Бизнес-пайплайн

Не затрагивается — чистый рефакторинг без изменения бизнес-логики.

### 4.2 Data Pipeline

Не затрагивается.

### 4.3 Интеграционный пайплайн

**Точки интеграции:**

| ID | От | К | Протокол | Описание |
|----|----|---|----------|----------|
| INT-001 | Business API | External AI APIs | HTTP/REST | OpenAI-compatible endpoints |

**Контракты API:** Без изменений — тот же формат запросов/ответов.

### 4.4 Влияние на существующие пайплайны

**Режим:** FEATURE (рефакторинг)

| Пайплайн | Тип изменения | Затрагиваемые этапы | Обратная совместимость |
|----------|---------------|---------------------|------------------------|
| ai_providers | modify (internal) | generate(), health_check() | Да |

**Breaking changes:**
- [x] Нет breaking changes — публичные интерфейсы сохранены

---

## 5. UI/UX требования

Не применимо — backend рефакторинг.

---

## 6. Нефункциональные требования

### 6.1 Производительность

| ID | Метрика | Требование | Измерение |
|----|---------|------------|-----------|
| NF-001 | Время отклика | Без деградации | Сравнение до/после |

### 6.2 Масштабируемость

Не применимо — рефакторинг.

### 6.3 Безопасность

| ID | Требование | Описание |
|----|------------|----------|
| NF-020 | API keys | Не логировать API ключи |
| NF-021 | Error messages | Не раскрывать sensitive data в ошибках |

### 6.4 Надёжность

| ID | Метрика | Требование |
|----|---------|------------|
| NF-030 | Тесты | Все существующие тесты должны проходить |

### 6.5 Требования к тестированию

#### Smoke тесты (ОБЯЗАТЕЛЬНО)
- [ ] Health check всех провайдеров работает
- [ ] generate() возвращает ответ для каждого провайдера

#### Unit тесты
- **Требуются**: Да
- **Порог покрытия**: ≥75%
- **Критические модули**: base.py, все провайдеры

#### Integration тесты
- **Требуются**: Нет (mock-based тесты достаточны)

#### Сводная таблица

| ID | Тип | Требование | Обязательно |
|----|-----|-----------|-------------|
| TRQ-001 | Smoke | Health check всех провайдеров | ✅ Да |
| TRQ-002 | Unit | Coverage ≥75% для base.py | ✅ Да |
| TRQ-003 | Regression | Все существующие тесты проходят | ✅ Да |

---

## 7. Технические ограничения

### 7.1 Обязательные технологии

- **Backend**: Python 3.11+, FastAPI
- **HTTP Client**: httpx (async)
- **Typing**: полные type hints

### 7.2 Файлы для изменения

| Файл | Действие | Описание |
|------|----------|----------|
| `base.py` | Modify | Добавить OpenAICompatibleProvider класс |
| `groq.py` | Modify | Конвертировать в конфигурацию |
| `cerebras.py` | Modify | Конвертировать в конфигурацию |
| `sambanova.py` | Modify | Конвертировать в конфигурацию |
| `deepseek.py` | Modify | Конвертировать в конфигурацию |
| `openrouter.py` | Modify | Конвертировать в конфигурацию |
| `hyperbolic.py` | Modify | Конвертировать в конфигурацию |
| `huggingface.py` | Modify | Конвертировать в конфигурацию |
| `github_models.py` | Modify | Конвертировать в конфигурацию |
| `fireworks.py` | Modify | Конвертировать в конфигурацию |
| `novita.py` | Modify | Конвертировать в конфигурацию |
| `kluster.py` | Modify | Конвертировать в конфигурацию |
| `scaleway.py` | Modify | Конвертировать в конфигурацию |
| `cloudflare.py` | **NO CHANGE** | Не OpenAI-compatible |

### 7.3 Ограничения

- **AIDD**: Общий код между сервисами через копирование, не общие модули
- **Cloudflare**: Исключён из рефакторинга (другой API формат)

---

## 8. Допущения и риски

### 8.1 Допущения

| # | Допущение | Влияние если неверно |
|---|-----------|---------------------|
| 1 | Все 11 провайдеров используют идентичный OpenAI формат | Потребуется больше hook методов |
| 2 | Текущие тесты покрывают основные сценарии | Могут быть незамеченные регрессии |

### 8.2 Риски

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | Провайдер имеет нестандартный header/payload | Low | Med | Hook методы для кастомизации |
| 2 | Регрессия в работе провайдера | Med | High | Прогон всех тестов, ручная проверка |

---

## 9. Открытые вопросы

| # | Вопрос | Статус | Ответственный | Решение |
|---|--------|--------|--------------|---------|
| 1 | Все ли провайдеры используют одинаковый формат headers? | Resolved | AI | Да, все используют Authorization: Bearer |
| 2 | Есть ли особенности у HuggingFace? | Resolved | AI | Немного другой base_url, но тот же формат |

---

## 10. Глоссарий

| Термин | Определение |
|--------|-------------|
| OpenAI-compatible | API, использующий формат запросов/ответов OpenAI Chat Completions |
| Provider | Класс-обёртка для внешнего AI API |
| Hook method | Метод, который можно переопределить в наследнике для кастомизации |

---

## 11. История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2026-01-30 | AI Analyst | Первоначальная версия |

---

## Качественные ворота

### PRD_READY Checklist

- [x] Все секции заполнены
- [x] Требования имеют уникальные ID (FR-001...FR-020)
- [x] Критерии приёмки определены для каждого требования
- [x] User stories связаны с требованиями
- [x] Влияние на существующие пайплайны описано
- [x] Нет блокирующих открытых вопросов
- [x] Риски идентифицированы и имеют план митигации

---

## Ожидаемый результат

**До рефакторинга:**
```
14 файлов × ~143 строки = ~2,000 строк
11 файлов с 95% дублированием
```

**После рефакторинга:**
```
base.py: ~150 строк (OpenAICompatibleProvider)
11 провайдеров × ~15 строк = ~165 строк
cloudflare.py: ~160 строк (без изменений)
─────────────────────────────────────
Итого: ~475 строк вместо ~2,000
Сокращение: ~76%
```
