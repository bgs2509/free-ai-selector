---
feature_id: "F019"
feature_name: "model-id-priority-fallback"
title: "Выбор модели по model_id с fallback на авто-выбор"
created: "2026-02-11"
author: "AI (Analyst)"
type: "prd"
status: "PRD_READY"
version: 1
mode: "FEATURE"

related_features: [F010, F011-B, F012, F018]
services: [free-ai-selector-business-api]
requirements_count: 10

pipelines:
  business: true
  data: true
  integration: true
  modified: [business-api]
---

# PRD: Выбор модели по `model_id` с fallback на авто-выбор

**Feature ID**: F019  
**Версия**: 1.0  
**Дата**: 2026-02-11  
**Автор**: AI Agent (Аналитик)  
**Статус**: Approved

---

## 1. Обзор

### 1.1 Проблема

Сейчас `POST /api/v1/prompts/process` не позволяет клиенту выбрать конкретную модель.  
Логика всегда использует автоматический выбор по `effective_reliability_score`.

Это не покрывает сценарии:
- принудительный запуск через конкретную модель по `id`;
- отладка и сравнение конкретных провайдеров;
- контролируемый rollout/проверка выбранной модели с автоматическим резервом.

### 1.2 Решение

Добавить в запрос опциональное поле `model_id`.

Поведение:
- если `model_id` указан и такая модель доступна для вызова, она пробуется первой;
- если модель не найдена или не отвечает, выполняется fallback на остальные модели по текущей стратегии (F010/F012);
- если `model_id` не указан, поведение полностью как сейчас.

### 1.3 Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| API-клиенты | Внешние и внутренние клиенты Business API | Управляемый выбор модели |
| QA/Dev | Тестирование и диагностика | Повторяемые сценарии на конкретной модели |
| Операторы | Эксплуатация сервиса | Стабильный fallback без ручного вмешательства |

### 1.4 Ценностное предложение

- Даёт управляемый выбор модели без потери отказоустойчивости.
- Сохраняет обратную совместимость для текущих клиентов.
- Использует существующий механизм fallback, без усложнения архитектуры.

---

## 2. Функциональные требования

### 2.1 Core Features (Must Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-001 | `model_id` в API запросе | Добавить опциональное поле `model_id` в `ProcessPromptRequest` | `POST /prompts/process` принимает запросы и с `model_id`, и без него |
| FR-002 | `model_id` в DTO use case | Добавить `model_id: Optional[int]` в `PromptRequest` | Значение из API слоя передаётся в `ProcessPromptUseCase.execute()` |
| FR-003 | Принудительный приоритет модели | Если указанная модель доступна и сконфигурирована, пробовать её первой | При `model_id=Y` и успехе провайдера ответ возвращён от модели `Y` даже при меньшем score |
| FR-004 | Fallback при отсутствии модели | Если `model_id` не найден среди доступных/сконфигурированных моделей, выполнить стандартный авто-выбор | Запрос не падает, выбирается модель по текущему score-механизму |
| FR-005 | Fallback при ошибке модели | Если выбранная по `model_id` модель падает/timeout/429/другая ошибка, пробовать следующие модели | При падении модели `Y` успешный ответ возвращается от следующей доступной модели |
| FR-006 | Обратная совместимость | Текущие клиенты без `model_id` работают без изменений | Существующие smoke сценарии без `model_id` остаются зелёными |

### 2.2 Important Features (Should Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-010 | Валидация `model_id` | `model_id` должен быть целым `> 0` | Некорректный `model_id` даёт 422 на уровне schema |
| FR-011 | Наблюдаемость выбора | Логировать факт запроса конкретной модели и причину fallback | В логах есть `requested_model_id`, `requested_model_found`, `selection_mode` |
| FR-012 | Сохранение F011-B параметров | При forced/fallback сохранять `system_prompt` и `response_format` | Параметры доходят до провайдера в forced и fallback попытках |
| FR-013 | Корректная статистика/история | Статистика успеха/ошибки и history пишутся для реально вызванных моделей | В history `selected_model_id` соответствует фактически успешной модели |

### 2.3 Nice to Have (Could Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-020 | Явный индикатор fallback в response | Добавить в API ответ флаг `used_fallback` | Клиент видит, был ли fallback после forced выбора |

---

## 3. User Stories

### US-001: Принудительный запуск через конкретную модель

**Как** API-клиент  
**Я хочу** передать `model_id` в запросе  
**Чтобы** отправить промпт в нужную модель первой

**Критерии приёмки:**
- [ ] Запрос с валидным `model_id` обрабатывается без 4xx/5xx из-за самой опции
- [ ] При успехе forced модели ответ возвращается именно от неё
- [ ] Без `model_id` используется текущий авто-выбор

**Связанные требования:** FR-001, FR-002, FR-003, FR-006

---

### US-002: Резерв при ошибке выбранной модели

**Как** API-клиент  
**Я хочу** автоматический переход на другую модель при ошибке выбранной  
**Чтобы** не терять ответ пользователю

**Критерии приёмки:**
- [ ] Если `model_id` не найден, выполняется авто-выбор
- [ ] Если forced модель не отвечает, включается fallback на следующую
- [ ] Ошибки и статистика фиксируются корректно

**Связанные требования:** FR-004, FR-005, FR-011, FR-013

---

## 4. Пайплайны

### 4.0 Тип изменений

| Параметр | Значение |
|----------|----------|
| Режим | FEATURE |
| Затрагиваемые пайплайны | Business pipeline выбора модели, интеграция Client → Business API |

### 4.1 Бизнес-пайплайн

**Новый flow:**

```text
[Request(prompt, model_id?)]
    -> [Load active+available models]
    -> [Filter configured models]
    -> [If model_id provided: build candidates = [requested_model] + [others_by_score]]
    -> [Else: candidates = models_by_score]
    -> [Try candidates one-by-one with existing retry/fallback rules]
    -> [Success -> response]
    -> [All failed -> error]
```

### 4.2 Data Pipeline

```text
Client -> Business API (/api/v1/prompts/process, model_id optional)
Business API -> Data API (/api/v1/models, existing endpoint)
Business API -> Data API (/api/v1/models/{id}/increment-*, /history)
```

Изменений в контракте Data API не требуется.

### 4.3 Интеграционный пайплайн

| ID | От | К | Протокол | Endpoint | Изменение |
|----|----|---|----------|----------|-----------|
| INT-001 | Client | Business API | HTTP/REST | `POST /api/v1/prompts/process` | Добавляется опциональный `model_id` |
| INT-002 | Business API | Data API | HTTP/REST | `GET /api/v1/models` | Переиспользуется без изменений |
| INT-003 | Business API | Data API | HTTP/REST | `POST /api/v1/models/{id}/increment-*`, `POST /api/v1/history` | Без изменений, но проверяется корректность при forced/fallback |

### 4.4 Влияние на существующие пайплайны

| Пайплайн | Тип изменения | Затрагиваемые этапы | Обратная совместимость |
|----------|---------------|---------------------|------------------------|
| Business API process_prompt | modify | Валидация request, формирование списка кандидатов, fallback | Да |
| Data API models/history | none | — | Да |
| Telegram Bot | none (опционально) | — | Да |

**Breaking changes:**
- [x] Нет breaking changes (новое поле опционально)

---

## 5. UI/UX требования

UI-изменения не входят в scope.  
Фича реализуется на уровне API-контракта и бизнес-логики.

---

## 6. Нефункциональные требования

### 6.1 Производительность

| ID | Метрика | Требование | Измерение |
|----|---------|------------|-----------|
| NF-001 | Дополнительная задержка выбора | Не более +10ms к текущему шагу селекции | unit/integration profiling |
| NF-002 | Количество HTTP вызовов в Data API | Не увеличивать (оставить текущий запрос моделей) | лог/trace сравнение |

### 6.2 Безопасность

| ID | Требование | Описание |
|----|------------|----------|
| NF-020 | Безопасные логи | Не логировать секреты и API-ключи, только технические идентификаторы |

### 6.3 Надёжность

| ID | Метрика | Требование |
|----|---------|------------|
| NF-030 | Устойчивость при forced ошибках | При ошибке forced модели выполняется fallback без остановки потока |
| NF-031 | Совместимость | Клиенты без `model_id` работают как ранее |

### 6.5 Требования к тестированию

#### Smoke тесты (обязательно)
- [ ] `POST /prompts/process` без `model_id` работает как раньше
- [ ] `POST /prompts/process` с валидным `model_id` (успех forced модели)
- [ ] `POST /prompts/process` с несуществующим `model_id` уходит в авто-выбор
- [ ] `POST /prompts/process` с падающей forced моделью уходит в fallback

#### Unit тесты
- Требуются: Да
- Порог покрытия: ≥75%
- Критические модули: `schemas.py`, `prompts.py`, `process_prompt.py`

#### Integration тесты
- Требуются: Да
- Критический пайплайн: Client → Business API → Data API → Provider fallback

#### E2E тесты
- Требуются: Нет (в рамках этой фичи)

#### Сводная таблица

| ID | Тип | Требование | Обязательно |
|----|-----|-----------|-------------|
| TRQ-001 | Smoke | Запрос без `model_id` не регрессирует | Да |
| TRQ-002 | Smoke | Forced модель успешно выбирается первой | Да |
| TRQ-003 | Smoke | Non-existent `model_id` корректно fallback | Да |
| TRQ-004 | Smoke | Forced ошибка переводит на другую модель | Да |
| TRQ-005 | Unit | Валидация `model_id > 0` | Да |
| TRQ-006 | Unit | Кандидаты формируются: forced first + others | Да |
| TRQ-007 | Integration | Сквозной сценарий forced→fallback | Да |
| TRQ-008 | Integration | Сохранение `system_prompt`/`response_format` на fallback | Да |

---

## 7. Технические ограничения

### 7.1 Обязательные технологии

- Python 3.11+
- FastAPI
- Pydantic
- текущий retry/fallback механизм F012 (без замены)

### 7.2 Ограничения

- Не добавлять новые зависимости.
- Не менять контракт Data API.
- Не ломать текущие клиенты без `model_id`.
- Использовать существующую архитектуру `DataAPIClient` и `ProviderRegistry`.

---

## 8. Допущения и риски

### 8.1 Допущения

| # | Допущение | Влияние если неверно |
|---|-----------|---------------------|
| 1 | `model_id` ожидается как ID модели из Data API | При несовпадении ID между средами forced выбор может не сработать |
| 2 | Существующий fallback F012 покрывает нужные ошибки "не отвечает" | Понадобится уточнение перечня ошибок |

### 8.2 Риски

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | Принудительно выбранная слабая модель ухудшит UX | Medium | Medium | Быстрый fallback на следующие модели |
| 2 | Дублирование кандидатов в fallback цепочке | Low | Medium | Явная дедупликация по `id` |
| 3 | Неполная наблюдаемость причин fallback | Medium | Low | Добавить structured logging по FR-011 |

---

## 9. Открытые вопросы

| # | Вопрос | Статус | Решение |
|---|--------|--------|---------|
| 1 | Нужен ли в response явный флаг, что сработал fallback? | Open | Вынести в FR-020 (опционально) |
| 2 | Нужно ли добавлять выбор `model_id` в Telegram UI? | Open | Вне scope текущей фичи, можно отдельным PRD |

---

## 10. Глоссарий

| Термин | Определение |
|--------|-------------|
| forced model | Модель, запрошенная через `model_id` |
| fallback | Переход к следующей модели при недоступности/ошибке текущей |
| configured model | Модель, для провайдера которой настроен API-ключ |

---

## 11. Затронутые файлы (план)

| Файл | Изменение |
|------|-----------|
| `services/free-ai-selector-business-api/app/api/v1/schemas.py` | Добавить `model_id` в `ProcessPromptRequest` |
| `services/free-ai-selector-business-api/app/api/v1/prompts.py` | Пробросить `model_id` в `PromptRequest` |
| `services/free-ai-selector-business-api/app/domain/models.py` | Добавить `model_id` в `PromptRequest` dataclass |
| `services/free-ai-selector-business-api/app/application/use_cases/process_prompt.py` | Реализовать forced-first candidate selection + fallback |
| `services/free-ai-selector-business-api/tests/unit/test_f011b_schemas.py` | Тесты schema для `model_id` |
| `services/free-ai-selector-business-api/tests/unit/test_process_prompt_use_case.py` | Тесты forced selection и fallback |

---

## 12. История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2026-02-11 | AI Analyst | Первоначальная версия PRD |

---

## Качественные ворота

### PRD_READY Checklist

- [x] Все секции заполнены
- [x] Требования имеют уникальные ID
- [x] Критерии приёмки определены
- [x] User stories связаны с требованиями
- [x] Бизнес-пайплайн описан
- [x] Data Pipeline описан
- [x] Интеграционный пайплайн описан
- [x] Раздел влияния на существующие пайплайны заполнен
- [x] Риски определены и имеют митигации
- [x] Документ согласован с заинтересованной стороной
