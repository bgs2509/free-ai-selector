---
# === YAML Frontmatter (машиночитаемые метаданные) ===
feature_id: "F011-C"
feature_name: "web-ui-advanced-params"
title: "Веб-интерфейс: System Prompt и JSON Response"
created: "2026-01-15"
author: "AI (Analyst)"
type: "_analysis"
status: "Draft"
version: 1
mode: "FEATURE"

# Связанные фичи
related_features:
  - F002  # web-ui (base)
  - F011-B  # system-prompts-json-response (backend)

# Затрагиваемые сервисы
services:
  - free-ai-selector-business-api

# Количество требований
requirements_count: 13

# Пайплайны
pipelines:
  business: true
  data: true
  integration: true
  modified:
    - "web-ui-interaction"  # F002 web UI flow
---

# PRD: Веб-интерфейс — System Prompt и JSON Response

**Feature ID**: F011-C
**Версия**: 1.0
**Дата**: 2026-01-15
**Автор**: AI Agent (Аналитик)
**Статус**: Draft

---

## 1. Обзор

### 1.1 Проблема

После внедрения F011-B (backend поддержка `system_prompt` и `response_format`), веб-интерфейс Free AI Selector не позволяет пользователям передавать эти параметры через UI.

**Боль пользователя:**
- Невозможно управлять поведением AI через system prompts (например, "Отвечай кратко", "Ты эксперт по Python")
- Нет способа запросить структурированный ответ в JSON формате для интеграций
- Приходится использовать curl или Postman для доступа к расширенным параметрам API

**Последствия:**
- Снижение ценности F011-B — функционал доступен только через API
- Плохой UX — пользователи не знают о новых возможностях
- Telegram бот остаётся единственным интерфейсом для простых запросов

### 1.2 Решение

Добавить в веб-интерфейс (`index.html`) два UI элемента для расширенных параметров:

1. **System Prompt** — отдельное `<textarea>` всегда видимое, опциональное
2. **Response Format** — два радио-баттона ("Текст" / "JSON")

При отправке формы параметры автоматически добавляются в POST запрос к `/api/v1/prompts/process`.

**Ключевые принципы:**
- Минимальное решение (без лишних фич)
- 100% backward compatible (параметры опциональны)
- Только веб-интерфейс (Telegram бот не затрагивается в v1)

### 1.3 Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| Разработчики API | Тестируют интеграции с AI | JSON ответы, точное управление через system prompts |
| Power users | Используют AI для задач автоматизации | Настройка поведения AI, структурированные ответы |
| Исследователи | Экспериментируют с AI моделями | Быстрый доступ к расширенным параметрам без кода |

### 1.4 Ценностное предложение

- **Для пользователей:** Полный контроль над AI-запросами через удобный UI
- **Для проекта:** Демонстрация возможностей F011-B, увеличение использования веб-интерфейса
- **Для разработки:** Минимальные изменения (1 HTML файл), быстрая реализация (~1 час)

---

## 2. Функциональные требования

### 2.1 Core Features (Must Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-001 | System Prompt UI элемент | Добавить `<textarea id="system-prompt-input">` в форму чата | Элемент видим всегда, placeholder "System prompt (опционально)" |
| FR-002 | System Prompt валидация | Ограничить длину system prompt до 5000 символов | При превышении показать ошибку "System prompt не должен превышать 5000 символов" |
| FR-003 | Response Format UI элемент | Добавить два радио-баттона: "Текст" (checked) и "JSON" | "Текст" выбран по умолчанию |
| FR-004 | Response Format визуализация | Сгруппировать радио-баттоны в блок с заголовком "Формат ответа" | Блок расположен между system prompt и кнопкой "Отправить" |
| FR-005 | Интеграция с API | При отправке формы добавлять `system_prompt` и `response_format` в POST запрос | Запрос содержит корректные JSON поля (см. API контракт) |
| FR-006 | Backward compatibility | Если system_prompt пустой, не отправлять поле в API (или отправить `null`) | Существующие запросы без system prompt работают как раньше |
| FR-007 | JSON response отображение | Если выбран "JSON" формат, отображать ответ с syntax highlighting или `<pre><code>` | Ответ читаем, сохранено форматирование JSON |
| FR-008 | Очистка формы | После отправки очищать prompt, но оставлять system_prompt и выбор формата | Пользователь может отправить несколько запросов с теми же настройками |

### 2.2 Important Features (Should Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-010 | Visual feedback | При отправке запроса с system prompt показывать индикатор | Badge "System: ✓" рядом с лоадером |
| FR-011 | UX hints | Добавить `title` атрибуты для подсказок | Hover на радио-баттонах показывает "Обычный текстовый ответ" / "Структурированный JSON ответ" |

### 2.3 Nice to Have (Could Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-020 | System prompt templates | Dropdown с готовыми шаблонами ("Краткие ответы", "Эксперт по коду", "JSON only") | Пользователь может выбрать шаблон, текст вставляется в textarea |

**Scope v1:** FR-001 до FR-011 (без FR-020 — шаблоны для v2)

---

## 3. User Stories

### US-001: Передача System Prompt через UI

**Как** разработчик API
**Я хочу** задать system prompt через веб-интерфейс
**Чтобы** контролировать поведение AI без написания кода

**Критерии приёмки:**
- [ ] В форме чата есть отдельное textarea с placeholder "System prompt (опционально)"
- [ ] Могу ввести текст до 5000 символов
- [ ] При превышении лимита вижу ошибку валидации
- [ ] При отправке формы system prompt передаётся в API

**Связанные требования:** FR-001, FR-002, FR-005, FR-006

---

### US-002: Запрос JSON ответа

**Как** интегратор системы
**Я хочу** переключиться на JSON формат ответа
**Чтобы** получить структурированные данные для автоматической обработки

**Критерии приёмки:**
- [ ] Вижу два радио-баттона: "Текст" и "JSON"
- [ ] По умолчанию выбран "Текст"
- [ ] Могу переключиться на "JSON" кликом
- [ ] При выборе "JSON" запрос содержит `response_format: {type: "json_object"}`
- [ ] Ответ отображается с форматированием (syntax highlighting или `<pre>`)

**Связанные требования:** FR-003, FR-004, FR-005, FR-007

---

### US-003: Повторные запросы с теми же настройками

**Как** исследователь AI
**Я хочу** отправить несколько разных промптов с одним system prompt
**Чтобы** не копировать system prompt вручную каждый раз

**Критерии приёмки:**
- [ ] После отправки запроса prompt очищается
- [ ] System prompt остаётся заполненным
- [ ] Выбор формата ответа сохраняется
- [ ] Могу быстро ввести новый prompt и отправить

**Связанные требования:** FR-008

---

## 4. Пайплайны

### 4.0 Тип изменений

| Параметр | Значение |
|----------|----------|
| Режим | FEATURE (расширение существующего веб-интерфейса F002) |
| Затрагиваемые пайплайны | Web UI Interaction Pipeline (F002) |

### 4.1 Бизнес-пайплайн

> Последовательность взаимодействия пользователя с расширенными параметрами AI

**Основной flow:**

```
[Пользователь открывает веб-интерфейс]
    ↓
[Видит форму с 3 полями: prompt (обязательно), system_prompt (опционально), format (радио)]
    ↓
[Заполняет prompt] → [Опционально: заполняет system_prompt] → [Опционально: выбирает JSON]
    ↓
[Нажимает "Отправить"]
    ↓
[Валидация на клиенте] ← (система: prompt не пустой, system_prompt ≤5000)
    ↓ ОК                                ↓ FAIL
[POST /api/v1/prompts/process]    [Показать ошибку валидации]
    ↓
[Backend обрабатывает]
    ↓
[Ответ приходит]
    ↓
[Отображение ответа] ← (если JSON: форматирование, если text: как раньше)
    ↓
[Prompt очищен, system_prompt и format сохранены] → [Готов к следующему запросу]
```

| # | Этап | Описание | Условия перехода | Результат |
|---|------|----------|------------------|-----------|
| 1 | Открытие формы | Пользователь видит 3 поля ввода | — | Form ready |
| 2 | Заполнение данных | Пользователь вводит prompt, опционально system_prompt и выбирает format | Кнопка "Отправить" активна | Data entered |
| 3 | Client-side валидация | Проверка: prompt не пустой, system_prompt ≤5000 | Валидация успешна | Data valid |
| 4 | API запрос | POST к `/api/v1/prompts/process` с полями `prompt`, `system_prompt`, `response_format` | Backend доступен | Request sent |
| 5 | Обработка ответа | Backend возвращает AI-ответ | Status 200 OK | Response received |
| 6 | Отображение ответа | Текст или JSON (с форматированием) показан в UI | — | Response displayed |
| 7 | Подготовка к новому запросу | Prompt очищен, остальное сохранено | — | Ready for next |

**Альтернативные flow:**

- **Ошибка валидации:** Показать красное сообщение → Пользователь исправляет → Возврат к этапу 3
- **Backend error 500:** Показать "Ошибка обработки запроса" → Пользователь повторяет → Возврат к этапу 4
- **Timeout:** Показать "Превышено время ожидания" → Пользователь повторяет → Возврат к этапу 4

### 4.2 Data Pipeline

> Поток данных между веб-интерфейсом и Business API

**Диаграмма потока данных:**

```
┌─────────────────┐                   ┌──────────────────────┐
│   Web Browser   │                   │   Business API       │
│   (index.html)  │                   │   (FastAPI:8000)     │
└────────┬────────┘                   └──────────┬───────────┘
         │                                       │
         │  1. User fills form                   │
         │     - prompt: "Explain AI"            │
         │     - system_prompt: "Be brief"       │
         │     - format: "JSON" radio            │
         │                                       │
         │  2. Click "Отправить"                 │
         │                                       │
         │  3. JavaScript builds payload         │
         │     {                                 │
         │       prompt: "Explain AI",           │
         │       system_prompt: "Be brief",      │
         │       response_format: {              │
         │         type: "json_object"           │
         │       }                               │
         │     }                                 │
         │                                       │
         │  4. POST /api/v1/prompts/process      │
         ├──────────────────────────────────────▶│
         │                                       │
         │                                       │  5. Validate schema
         │                                       │     (Pydantic)
         │                                       │
         │                                       │  6. ProcessPromptUseCase
         │                                       │     передаёт параметры
         │                                       │     в AI Provider
         │                                       │
         │                                       │  7. AI Provider строит
         │                                       │     messages array:
         │                                       │     [
         │                                       │       {role: "system",
         │                                       │        content: "Be brief"},
         │                                       │       {role: "user",
         │                                       │        content: "Explain AI"}
         │                                       │     ]
         │                                       │
         │  8. Response 200 OK                   │
         │◀──────────────────────────────────────┤
         │     {                                 │
         │       response: "{\"answer\":...}",   │
         │       selected_model: "llama-3.1",    │
         │       provider: "Groq"                │
         │     }                                 │
         │                                       │
         │  9. JavaScript парсит ответ           │
         │                                       │
         │  10. Отображает в <div>               │
         │      с форматированием (если JSON)    │
         │                                       │
         │  11. Очищает prompt,                  │
         │      сохраняет system_prompt + format │
         │                                       │
```

**Трансформации данных:**

| # | Точка | Входные данные | Преобразование | Выходные данные |
|---|-------|----------------|----------------|-----------------|
| 1 | Client (JS) | Form fields (HTML) | `{prompt, system_prompt, response_format}` → JSON | POST payload |
| 2 | Business API (Pydantic) | JSON payload | Валидация → `ProcessPromptRequest` DTO | Domain DTO `PromptRequest` |
| 3 | Use Case | `PromptRequest` DTO | Извлечение параметров → kwargs | `provider.generate(prompt, system_prompt=..., response_format=...)` |
| 4 | AI Provider | kwargs | Построение messages array | OpenAI-compatible API request |
| 5 | Business API (Response) | AI text response | Обёртка в `ProcessPromptResponse` | JSON response |
| 6 | Client (JS) | JSON response | Парсинг → HTML rendering | Displayed text/JSON |

### 4.3 Интеграционный пайплайн

> Взаимодействие между веб-интерфейсом и Business API

**Карта сервисов:**

```
┌────────────────────────────────────────────────────────────────┐
│                      FREE AI SELECTOR                          │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│   ┌─────────────────────┐        ┌─────────────────────┐      │
│   │   Web UI            │        │   Business API      │      │
│   │   (index.html)      │───────▶│   (FastAPI)         │      │
│   │                     │  HTTP  │                     │      │
│   │   NEW: F011-C       │        │   F011-B (backend)  │      │
│   │   - system prompt   │        │   - system_prompt   │      │
│   │   - format radio    │        │   - response_format │      │
│   └─────────────────────┘        └─────────────────────┘      │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

**Точки интеграции:**

| ID | От | К | Протокол | Endpoint | Описание |
|----|----|----|----------|----------|----------|
| INT-001 | Web UI | Business API | HTTP/REST | POST /api/v1/prompts/process | Отправка промпта с расширенными параметрами |

**Контракты API:**

**INT-001: POST /api/v1/prompts/process**

**Request (NEW: F011-C):**
```json
{
  "prompt": "Explain AI in simple terms",          // Required
  "system_prompt": "You are a helpful teacher",    // Optional (NEW)
  "response_format": {                             // Optional (NEW)
    "type": "json_object"
  }
}
```

**Response (без изменений):**
```json
{
  "prompt": "Explain AI in simple terms",
  "response": "{\"explanation\": \"...\"}",  // или plain text
  "selected_model": "llama-3.1-70b-versatile",
  "provider": "Groq",
  "response_time_seconds": 1.25,
  "success": true
}
```

**Errors:**
- `400 Bad Request` — валидация Pydantic (например, system_prompt > 5000 символов)
- `422 Unprocessable Entity` — некорректный JSON
- `500 Internal Server Error` — backend ошибка обработки
- `503 Service Unavailable` — нет активных AI моделей

### 4.4 Влияние на существующие пайплайны

**Режим:** FEATURE

| Пайплайн | Тип изменения | Затрагиваемые этапы | Обратная совместимость |
|----------|---------------|---------------------|------------------------|
| F002 Web UI Interaction | Расширение (add) | Заполнение формы (добавлены 2 поля), API запрос (добавлены 2 параметра), Отображение ответа (добавлено форматирование JSON) | Да — новые поля опциональны |
| F011-B System Prompts Backend | Без изменений | — | Да — backend готов принимать параметры |

**Breaking changes:**
- [ ] Нет breaking changes
- [x] UI полностью backward compatible: если пользователь не заполняет новые поля, запрос идентичен старому

**Риски:**
- Пользователи могут неправильно понять назначение system_prompt → Митигация: placeholder с понятным текстом
- Выбор "JSON" может дать text ответ если провайдер не поддерживает → Митигация: это graceful degradation (уже реализовано в F011-B)

---

## 5. UI/UX требования

### 5.1 Экраны и интерфейсы

| ID | Экран | Описание | Приоритет |
|----|-------|----------|-----------|
| UI-001 | Форма чата (расширенная) | Добавить `<textarea>` для system prompt между полем prompt и кнопкой | Must |
| UI-002 | Блок "Формат ответа" | Два радио-баттона "Текст" и "JSON" с label над ними | Must |
| UI-003 | Ошибка валидации | Красный `<div>` под system prompt при превышении 5000 символов | Must |
| UI-004 | JSON syntax highlighting | `<pre><code>` с CSS классом для форматирования или библиотека highlight.js | Should |

### 5.2 User Flows

**Flow 1: Простой запрос (без расширенных параметров)**

```
[Открыть веб-интерфейс] → [Ввести prompt] → [Игнорировать system_prompt и format]
    → [Отправить] → [Получить text ответ] → [Как раньше]
```

**Flow 2: Запрос с system prompt**

```
[Открыть веб-интерфейс] → [Ввести prompt] → [Ввести system prompt: "Be brief"]
    → [Формат: "Текст" (default)] → [Отправить] → [Получить краткий text ответ]
```

**Flow 3: Запрос JSON ответа**

```
[Открыть веб-интерфейс] → [Ввести prompt: "List 3 colors"] → [Оставить system_prompt пустым]
    → [Формат: "JSON"] → [Отправить] → [Получить {"colors": [...]}]
    → [Отобразить с форматированием]
```

**Flow 4: Множественные запросы**

```
[Первый запрос с system_prompt="Code expert" и format="JSON"]
    → [Отправить] → [Ответ получен]
    → [Prompt очищен, system_prompt и format сохранены]
    → [Ввести новый prompt] → [Отправить] → [Те же настройки применены]
```

### 5.3 Требования к доступности

- [ ] Поддержка клавиатурной навигации (Tab между полями)
- [ ] Label для всех input элементов (для screen readers)
- [ ] Контрастность текста ≥ 4.5:1 (соответствует существующему дизайну)
- [ ] `title` атрибуты для подсказок (hover hints)

**Примечание:** Полная accessibility проверка в рамках общего аудита UI (вне scope F011-C).

---

## 6. Нефункциональные требования

### 6.1 Производительность

| ID | Метрика | Требование | Измерение |
|----|---------|------------|-----------|
| NF-001 | Время загрузки страницы | < 3s (без изменений от F002) | Lighthouse |
| NF-002 | Отзывчивость UI | Валидация ≤ 50ms | Manual testing |
| NF-003 | Размер HTML файла | Увеличение ≤ 2KB | File size comparison |

### 6.2 Масштабируемость

| ID | Требование | Описание |
|----|------------|----------|
| NF-010 | Статический HTML | Нет server-side rendering, файл статичен |
| NF-011 | Клиентская валидация | Снижение нагрузки на backend за счёт ранней валидации |

### 6.3 Безопасность

| ID | Требование | Описание |
|----|------------|----------|
| NF-020 | XSS защита | Escape HTML в отображаемом ответе (уже реализовано в F002: `escapeHtml()`) |
| NF-021 | Length validation | Клиентская проверка длины system_prompt ≤ 5000 (дублирует backend Pydantic) |
| NF-022 | No secrets in UI | System prompt может содержать чувствительные данные — пользователь несёт ответственность |

**Важно:** Backend валидация является final authority (клиентская — для UX).

### 6.4 Надёжность

| ID | Метрика | Требование |
|----|---------|------------|
| NF-030 | Fallback для unsupported format | Если backend вернул text при запросе JSON — показать как text (без ошибки) |
| NF-031 | Error handling | Показать понятное сообщение при любой ошибке API |

---

## 7. Технические ограничения

### 7.1 Обязательные технологии

- **Frontend**: Vanilla JavaScript (как в F002), без фреймворков
- **Стилизация**: Inline CSS в `<style>` тег (текущий подход)
- **HTTP Client**: `fetch()` API (браузерный нативный)
- **JSON parsing**: `JSON.stringify()`, `JSON.parse()`

### 7.2 Интеграции

| Система | Тип интеграции | Описание |
|---------|---------------|----------|
| Business API | REST API | POST /api/v1/prompts/process с новыми полями |

### 7.3 Ограничения

- **Одностраничность**: Весь код в одном `index.html` (соответствие F002)
- **Без внешних зависимостей**: Никакие npm пакеты не используются
- **Только веб-интерфейс**: Telegram бот не затрагивается в v1
- **Нет сохранения в БД**: System prompts не сохраняются в prompt_history (v1)

---

## 8. Допущения и риски

### 8.1 Допущения

| # | Допущение | Влияние если неверно |
|---|-----------|---------------------|
| 1 | F011-B (backend) работает корректно | Запросы с новыми параметрами будут падать с 422/500 |
| 2 | Пользователи понимают назначение system prompt | Неправильное использование, путаница с обычным prompt |
| 3 | JSON ответы всегда валидны (если запрошены) | Ошибки парсинга JSON при отображении |
| 4 | Большинство пользователей не используют system prompt (опциональная фича) | Нет влияния — backward compatible |

### 8.2 Риски

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | Пользователи вводят очень длинные system prompts | Средняя | Низкое | Клиентская валидация 5000 символов, backend тоже валидирует |
| 2 | Провайдер возвращает text при запросе JSON | Средняя | Низкое | Graceful display: показать text если не JSON (без ошибки) |
| 3 | JSON syntax highlighting замедляет UI | Низкая | Среднее | Использовать простой `<pre><code>` без библиотек (v1) |
| 4 | Пользователи не находят новые поля (плохая discovery) | Средняя | Среднее | Разместить system prompt визуально заметно, добавить placeholder с подсказкой |
| 5 | Конфликт с существующими CSS классами | Низкая | Низкое | Использовать уникальные имена классов (`.system-prompt-textarea`, `.format-radio-group`) |

---

## 9. Открытые вопросы

| # | Вопрос | Статус | Ответственный | Решение |
|---|--------|--------|--------------|---------|
| 1 | Нужны ли готовые шаблоны system prompts (FR-020) в v1? | Open | Пользователь | Решение: исключить из v1, добавить в v2 при необходимости |
| 2 | Использовать ли библиотеку для JSON highlighting (highlight.js)? | Open | Архитектор | Решение: v1 без библиотек (`<pre><code>`), v2 если нужно |
| 3 | Нужна ли кнопка "Очистить всё" для сброса system_prompt и format? | Open | UX | Решение: нет в v1 (пользователь может очистить вручную) |
| 4 | Показывать ли счётчик символов для system_prompt? | Open | UX | Решение: нет в v1 (показываем ошибку при превышении) |

---

## 10. Глоссарий

| Термин | Определение |
|--------|-------------|
| System Prompt | Инструкция для AI, задающая контекст и стиль ответа (например, "Ты эксперт по Python") |
| Response Format | Спецификация формата ответа AI (в данном случае: text или json_object) |
| JSON Object | Структурированный ответ в формате JSON (например, `{"answer": "..."}`) |
| Graceful Degradation | Способность системы продолжать работать при частичной недоступности функций (например, text ответ вместо JSON) |
| Backward Compatible | Изменения не ломают существующее поведение (старые клиенты работают как раньше) |

---

## 11. История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2026-01-15 | AI Analyst | Первоначальная версия PRD для F011-C |

---

## Качественные ворота

### PRD_READY Checklist

- [x] Все секции заполнены
- [x] Требования имеют уникальные ID (FR-001 до FR-020, UI-001 до UI-004, NF-001 до NF-031, INT-001)
- [x] Критерии приёмки определены для каждого требования
- [x] User stories связаны с требованиями
- [x] Бизнес-пайплайн описан (основной flow, альтернативные flow, состояния)
- [x] Data Pipeline описан (диаграмма потоков, трансформации данных)
- [x] Интеграционный пайплайн описан (карта сервисов, точки интеграции INT-001, контракты API)
- [x] Раздел "Влияние на существующие пайплайны" заполнен (F002 расширен, F011-B без изменений)
- [x] Нет блокирующих открытых вопросов (все вопросы отложены на v2 или имеют решения)
- [x] Риски идентифицированы и имеют план митигации (5 рисков)
- [x] Документ готов к согласованию с заинтересованными сторонами

**Статус**: ✅ PRD_READY

---

**Следующий шаг**: `/aidd-_research` — Анализ кодовой базы веб-интерфейса (index.html)
