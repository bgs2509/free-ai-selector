# PRD: Расширение AI провайдеров до 20

**ID фичи:** F003
**Название:** expand-ai-providers
**Дата:** 2025-12-25
**Статус:** DRAFT

---

## 1. Обзор

### 1.1 Проблема

Текущая система Free AI Selector имеет 6 AI провайдеров, из которых 4 работают
нестабильно. Это создаёт риски для пользователей:
- Низкая надёжность при отказе основных провайдеров
- Ограниченный выбор моделей для fallback
- Зависимость от нестабильных API

### 1.2 Решение

Расширить количество AI провайдеров до 20, добавив только те, которые:
- **НЕ требуют кредитную карту**
- **НЕ требуют верификацию телефона**
- Имеют стабильные бесплатные tier
- Поддерживают OpenAI-совместимый API (предпочтительно)

### 1.3 Цели

| Метрика | Текущее | Целевое |
|---------|---------|---------|
| Количество провайдеров | 6 | 20 |
| Стабильных провайдеров | 2 | 15+ |
| Доступных моделей | 6 | 50+ |
| Uptime системы | ~95% | 99%+ |

---

## 2. Текущее состояние

### 2.1 Существующие провайдеры

| # | Провайдер | Статус | Проблема |
|---|-----------|--------|----------|
| 1 | Google Gemini | ⚠️ Снижены лимиты | Dec 2025: -50-80% |
| 2 | Groq | ✅ Стабильный | - |
| 3 | Cerebras | ⚠️ Нестабильный | Периодические сбои |
| 4 | SambaNova | ⚠️ Нестабильный | Медленный ответ |
| 5 | HuggingFace | ⚠️ Нестабильный | Низкие лимиты |
| 6 | Cloudflare | ⚠️ Нестабильный | Сложная авторизация |

### 2.2 Архитектура провайдеров

```
app/infrastructure/ai_providers/
├── base.py              # AIProviderBase (абстрактный класс)
├── google_gemini.py     # GoogleGeminiProvider
├── groq.py              # GroqProvider
├── cerebras.py          # CerebrasProvider
├── sambanova.py         # SambanovaProvider
├── huggingface.py       # HuggingFaceProvider
└── cloudflare.py        # CloudflareProvider
```

---

## 3. Новые провайдеры (БЕЗ БАРЬЕРОВ)

### 3.1 TIER 1: Приоритетные (постоянно бесплатные)

| # | Провайдер | Лимиты | OpenAI API | Модели |
|---|-----------|--------|------------|--------|
| 1 | **DeepSeek** | 5M токенов | ✅ | V3.2, R1, Coder |
| 2 | **Cohere** | 1K calls/месяц | Свой | Command R+, Aya |
| 3 | **OpenRouter** | 50 RPD, 20 RPM | ✅ | 30+ :free моделей |
| 4 | **GitHub Models** | 50 RPD, 10 RPM | ✅ | 40+ моделей |

### 3.2 TIER 2: Дополнительные (с кредитами)

| # | Провайдер | Кредиты | OpenAI API | Модели |
|---|-----------|---------|------------|--------|
| 5 | **Fireworks** | $1 | ✅ | 200+ |
| 6 | **Hyperbolic** | $1 | ✅ | 25+ |
| 7 | **Novita AI** | $10 + 5 free | ✅ | 200+ |
| 8 | **Scaleway** | 1M токенов | ✅ | 15 |
| 9 | **Kluster AI** | $5 | ✅ | 5+ |

### 3.3 ИСКЛЮЧЁННЫЕ (требуют барьеры)

| Провайдер | Причина |
|-----------|---------|
| ~~NVIDIA NIM~~ | Требует телефон |
| ~~Mistral AI~~ | Требует телефон |
| ~~NLP Cloud~~ | Требует кредитку |
| ~~Google Vertex AI~~ | Требует кредитку |

---

## 4. Функциональные требования

### FR-001: Базовый класс провайдера
- Все провайдеры наследуют от `AIProviderBase`
- Реализуют методы: `generate()`, `health_check()`, `get_provider_name()`

### FR-002: DeepSeek провайдер
- Интеграция с DeepSeek API (api.deepseek.com)
- Поддержка моделей: deepseek-chat, deepseek-coder
- OpenAI-совместимый формат

### FR-003: Cohere провайдер
- Интеграция с Cohere API
- Поддержка моделей: command-r-plus, command-r, aya
- Свой формат API

### FR-004: OpenRouter провайдер (агрегатор)
- Интеграция с OpenRouter API
- Доступ к 30+ бесплатным моделям через один endpoint
- Использовать как fallback при отказе прямых провайдеров

### FR-005: GitHub Models провайдер
- Интеграция через GitHub PAT токен
- Поддержка моделей: GPT-4o, Llama, DeepSeek

### FR-006: Fireworks провайдер
- Интеграция с Fireworks API
- OpenAI-совместимый формат

### FR-007: Hyperbolic провайдер
- Интеграция с Hyperbolic API
- OpenAI-совместимый формат

### FR-008: Novita AI провайдер
- Интеграция с Novita API
- 5 полностью бесплатных моделей

### FR-009: Scaleway провайдер
- Интеграция с Scaleway Generative APIs
- EU-based, GDPR compliant

### FR-010: Kluster AI провайдер
- Интеграция с Kluster API
- OpenAI-совместимый формат

- OpenAI-совместимый формат

### FR-012: Seed данные
- Добавить новые модели в seed.py
- Обновить SEED_MODELS список

### FR-013: Регистрация провайдеров
- Добавить все провайдеры в ProcessPromptUseCase.providers

### FR-014: Environment переменные
- Добавить API ключи в .env и docker-compose.yml

---

## 5. Нефункциональные требования

### NF-001: Совместимость
- Существующие провайдеры продолжают работать
- API контракты не меняются

### NF-002: Производительность
- Health check < 5 сек на провайдер
- Generate timeout = 30 сек

### NF-003: Надёжность
- При недоступности провайдера - fallback на следующий
- Логирование всех ошибок

### NF-004: Тестирование
- Unit тесты для каждого провайдера
- Покрытие ≥75%

---

## 6. Критерии приёмки

| # | Критерий | Проверка |
|---|----------|----------|
| AC-1 | 20 провайдеров реализовано | Файлы в ai_providers/ |
| AC-2 | Все health_check проходят | make health |
| AC-3 | Seed содержит все модели | make seed |
| AC-4 | Тесты проходят | make test-business |
| AC-5 | Документация обновлена | CLAUDE.md |

---

## 7. Риски

| Риск | Вероятность | Митигация |
|------|-------------|-----------|
| Изменение лимитов провайдера | Высокая | Мониторинг, fallback |
| Недоступность API | Средняя | Множественный fallback |
| Изменение API формата | Низкая | Версионирование |

---

## 8. Приоритизация

| Фаза | Провайдеры | Цель |
|------|------------|------|
| 1 | DeepSeek, Cohere, OpenRouter, GitHub | +4 стабильных |
| 2 | Fireworks, Hyperbolic, Novita, Scaleway | +4 с кредитами |

---

## 9. Зависимости

- httpx (уже установлен)
- Новые env переменные для API ключей
