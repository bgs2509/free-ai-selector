---
feature_id: "F007"
feature_name: "response-time-none-fix"
title: "Исправление бага response_time=None в /test"
created: "2025-12-31"
author: "AI (Analyst)"
type: "prd"
status: "PRD_READY"
version: 1
mode: "FEATURE"

related_features: ["F004", "F006"]
services: ["free-ai-selector-business-api"]
requirements_count: 5
---

# PRD: Исправление бага response_time=None в /test

**Feature ID**: F007
**Версия**: 1.0
**Дата**: 2025-12-31
**Автор**: AI Agent (Аналитик)
**Статус**: PRD_READY

---

## 1. Обзор

### 1.1 Проблема

При выполнении команды `/test` в Telegram боте, статистика ошибок провайдеров **не записывается** в базу данных из-за бага с передачей `response_time=None`.

**Симптомы в логах VPS:**
```
Failed to increment failure for model 1: Client error '422 Unprocessable Entity'
for url 'http://free-ai-selector-data-postgres-api:8001/api/v1/models/1/increment-failure?response_time='
```

**Причина:** В файле `test_all_providers.py` используется `dict.get("response_time", 0.0)`, но ключ `response_time` инициализирован как `None`. Метод `dict.get(key, default)` возвращает `default` только если ключ **отсутствует**. Если ключ присутствует со значением `None`, возвращается `None`.

**Последствия:**
- 12 из 16 провайдеров (failed) не получают обновление статистики
- Команда `/test` не выполняет свою цель — быть "третьим источником данных надёжности"
- Reliability score не отражает реальную статистику ошибок

### 1.2 Решение

Исправить логику получения `response_time` в `test_all_providers.py`:

**Было (строка 241):**
```python
response_time = test_result.get("response_time", 0.0)  # Вернёт None, не 0.0!
```

**Должно быть:**
```python
response_time = test_result.get("response_time") or 0.0  # Вернёт 0.0 если None
```

Также проверить аналогичный код в health-worker.

### 1.3 Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| Пользователи TG бота | Используют `/test` для проверки провайдеров | Корректное обновление статистики после тестов |
| Система мониторинга | Health-worker обновляет reliability score | Корректная статистика ошибок |

### 1.4 Ценностное предложение

- Корректное обновление reliability_score для всех провайдеров
- `/test` становится полноценным третьим источником данных надёжности
- Устранение 422 ошибок в логах

---

## 2. Функциональные требования

### 2.1 Core Features (Must Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-001 | Fix response_time None в test_all_providers | Заменить `dict.get("response_time", 0.0)` на `test_result.get("response_time") or 0.0` в обоих местах использования (строки 232, 241) | При `/test` нет 422 ошибок в логах; статистика обновляется для всех 16 провайдеров |
| FR-002 | Проверить health-worker на аналогичный баг | Проверить файл `health-worker/app/main.py` на аналогичную проблему с `response_time` | Health-worker не имеет ошибок 422 при обновлении статистики |

### 2.2 Important Features (Should Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-010 | Добавить unit-тест для None response_time | Написать тест, который проверяет корректную обработку `response_time=None` | Тест проходит; покрывает edge case |

### 2.3 Nice to Have (Could Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-020 | Инициализировать response_time как 0.0 | Изменить начальное значение `response_time` в result dict с `None` на `0.0` | `result["response_time"]` инициализируется как `0.0` вместо `None` |

---

## 3. User Stories

### US-001: Корректное обновление статистики при /test

**Как** пользователь Telegram бота
**Я хочу** чтобы команда `/test` корректно обновляла статистику всех провайдеров
**Чтобы** reliability_score отражал реальную надёжность, включая ошибки

**Критерии приёмки:**
- [ ] При выполнении `/test` нет ошибок 422 в логах
- [ ] Статистика increment_failure вызывается для failed провайдеров
- [ ] Статистика increment_success вызывается для successful провайдеров

**Связанные требования:** FR-001, FR-002

---

## 4. UI/UX требования

> Не применимо — это backend bugfix, UI не затрагивается.

---

## 5. Нефункциональные требования

### 5.1 Совместимость

| ID | Требование | Описание |
|----|------------|----------|
| NF-001 | Обратная совместимость | Изменение не ломает существующую логику API |
| NF-002 | Совместимость с Data API | response_time передаётся как float, не как пустая строка |

### 5.2 Тестирование

| ID | Метрика | Требование |
|----|---------|------------|
| NF-010 | Unit test coverage | Добавить тест для edge case response_time=None |

---

## 6. Технические ограничения

### 6.1 Затрагиваемые файлы

| Файл | Изменение |
|------|-----------|
| `services/free-ai-selector-business-api/app/application/use_cases/test_all_providers.py` | Строки 232, 241: fix None handling |
| `services/free-ai-selector-health-worker/app/main.py` | Проверить аналогичную проблему |
| `services/free-ai-selector-business-api/tests/unit/test_test_all_providers.py` | Добавить тест для None response_time |

### 6.2 Ограничения

- Минимальные изменения кода (2-4 строки)
- Не требует изменения API контрактов
- Не требует миграций БД

---

## 7. Допущения и риски

### 7.1 Допущения

| # | Допущение | Влияние если неверно |
|---|-----------|---------------------|
| 1 | Баг находится только в test_all_providers.py | Если баг есть в других местах, они будут обнаружены при review |
| 2 | Data API корректно обрабатывает response_time=0.0 | Если нет — нужен fix в Data API |

### 7.2 Риски

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | Аналогичный баг в health-worker | Medium | Low | Проверить код health-worker в рамках FR-002 |

---

## 8. Открытые вопросы

| # | Вопрос | Статус | Решение |
|---|--------|--------|---------|
| — | Нет открытых вопросов | — | — |

---

## 9. Глоссарий

| Термин | Определение |
|--------|-------------|
| response_time | Время ответа провайдера в секундах |
| increment_failure | Метод Data API для записи неудачного вызова |
| 422 Unprocessable Entity | HTTP ошибка валидации параметров |

---

## 10. История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2025-12-31 | AI Analyst | Первоначальная версия |

---

## Качественные ворота

### PRD_READY Checklist

- [x] Все секции заполнены
- [x] Требования имеют уникальные ID (FR-001, FR-002, FR-010, FR-020)
- [x] Критерии приёмки определены для каждого требования
- [x] User stories связаны с требованиями
- [x] Нет блокирующих открытых вопросов
- [x] Риски идентифицированы и имеют план митигации
- [x] Минимальный scope — только исправление бага
