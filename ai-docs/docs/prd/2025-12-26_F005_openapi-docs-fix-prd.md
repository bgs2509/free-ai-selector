---
feature_id: "F005"
feature_name: "openapi-docs-fix"
title: "PRD: Исправление OpenAPI Docs и Web UI навигации"
created: "2025-12-26"
author: "AI Agent (Аналитик)"
type: "prd"
status: "PRD_READY"
version: 1
---

# PRD: Исправление OpenAPI Docs и Web UI навигации

---

**Feature ID**: F005
**Название**: openapi-docs-fix
**Версия**: 1.0
**Дата**: 2025-12-26
**Автор**: AI Agent (Аналитик)
**Статус**: PRD_READY
**Режим**: FEATURE

---

## 1. Обзор

### 1.1 Проблема

При работе за nginx-proxy на VPS (путь `/free-ai-selector/`) возникают две проблемы с Web UI:

1. **Swagger UI не загружает OpenAPI spec** — запрос `/openapi.json` возвращает 404
2. **Ссылка "API Docs" ведёт на 404** — относительный путь `href="docs"` переходит на `/free-ai-selector/static/docs`

**Влияние:**
- Разработчики не могут использовать Swagger для тестирования API
- Пользователи видят ошибку "Failed to load API definition"

### 1.2 Анализ предыдущих решений

В **PRD F002** (web-ui) был идентифицирован риск:

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | ROOT_PATH не учитывается в JS | Med | **High** | Использовать относительные пути или BASE_URL |

**Реализованная митигация (F002):**
```javascript
const API_BASE = window.location.pathname.includes('/free-ai-selector/')
    ? '/free-ai-selector' : '';
```

**Проблема:** Митигация была применена к API вызовам (`apiCall()`), но **не к ссылке API Docs** (`href="docs"`) и **не к FastAPI openapi_url**.

### 1.3 Решение

Исправить оба пути для корректной работы за nginx-proxy:

1. **OpenAPI URL** — добавить `ROOT_PATH` в `openapi_url` параметр FastAPI
2. **API Docs ссылка** — сделать динамической с использованием `API_BASE`

### 1.4 Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| Разработчики | Тестируют API через Swagger | Работающий `/docs` эндпоинт |
| Пользователи Web UI | Переходят по ссылке "API Docs" | Корректная навигация |

---

## 2. Функциональные требования

### 2.1 Must Have

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-001 | Динамический OpenAPI URL | `openapi_url` учитывает `ROOT_PATH` при работе за nginx-proxy | `/free-ai-selector/docs` загружает spec через `/free-ai-selector/openapi.json` |
| FR-002 | Динамическая ссылка API Docs | Ссылка "API Docs" в index.html использует `API_BASE` | Клик на "API Docs" ведёт на `/free-ai-selector/docs` (на VPS) |

### 2.2 Should Have

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-010 | Обратная совместимость | Локальная разработка без ROOT_PATH работает как раньше | `/docs` работает на `localhost:8000` |

---

## 3. User Stories

### US-001: Использование Swagger UI

**Как** разработчик
**Я хочу** открыть `/free-ai-selector/docs` и видеть Swagger UI
**Чтобы** тестировать API эндпоинты

**Критерии приёмки:**
- [ ] Swagger UI загружается без ошибки "Failed to load API definition"
- [ ] OpenAPI spec загружается с корректного пути
- [ ] Все эндпоинты отображаются

**Связанные требования:** FR-001

### US-002: Переход на API документацию

**Как** пользователь Web UI
**Я хочу** нажать на ссылку "API Docs"
**Чтобы** посмотреть документацию API

**Критерии приёмки:**
- [ ] Ссылка ведёт на `/free-ai-selector/docs` (на VPS)
- [ ] Ссылка ведёт на `/docs` (локально)
- [ ] Нет 404 ошибки

**Связанные требования:** FR-002

---

## 4. UI/UX требования

| ID | Элемент | Описание | Приоритет |
|----|---------|----------|-----------|
| UI-001 | Ссылка API Docs | Должна использовать динамический путь | Must |

---

## 5. Нефункциональные требования

| ID | Требование | Описание |
|----|------------|----------|
| NF-001 | Обратная совместимость | Локальная разработка без изменений в `.env` |
| NF-002 | Минимальные изменения | Только 2 файла: `main.py`, `index.html` |

---

## 6. Технические ограничения

### 6.1 Файлы для изменения

| Файл | Изменение |
|------|-----------|
| `services/free-ai-selector-business-api/app/main.py` | Изменить `openapi_url` на динамический |
| `services/free-ai-selector-business-api/app/static/index.html` | Исправить ссылку API Docs |

### 6.2 Интеграции

- **nginx-proxy**: Существующая конфигурация не требует изменений
- **Docker**: Требуется пересборка образа после изменений

---

## 7. Допущения и риски

### 7.1 Допущения

| # | Допущение | Влияние если неверно |
|---|-----------|---------------------|
| 1 | `ROOT_PATH` передаётся в контейнер через `.env` | Потребуется настроить env на VPS |

### 7.2 Риски

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | Регрессия локальной разработки | Low | Med | Тестирование с пустым ROOT_PATH |

---

## 8. Открытые вопросы

| # | Вопрос | Статус | Решение |
|---|--------|--------|---------|
| — | Нет открытых вопросов | — | — |

---

## 9. Связь с предыдущими фичами

| Feature | Связь |
|---------|-------|
| F002 (web-ui) | Исходная реализация Web UI с идентифицированным риском ROOT_PATH |
| F004 (dynamic-providers-list) | Нет связи |

---

## 10. Глоссарий

| Термин | Определение |
|--------|-------------|
| `ROOT_PATH` | Префикс пути для работы за reverse proxy. Пример: `/free-ai-selector` |
| `openapi_url` | Параметр FastAPI, определяющий путь к OpenAPI спецификации |
| nginx-proxy | Внешний reverse proxy, маршрутизирующий `/free-ai-selector/` → Business API |

---

## 11. История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2025-12-26 | AI Analyst | Первоначальная версия |

---

## Качественные ворота

### PRD_READY Checklist

- [x] Все секции заполнены
- [x] Требования имеют уникальные ID (FR-001, FR-002, FR-010)
- [x] Критерии приёмки определены для каждого требования
- [x] User stories связаны с требованиями
- [x] Нет блокирующих открытых вопросов
- [x] Риски идентифицированы и имеют план митигации
- [x] Анализ предыдущих аналогичных проблем включён (F002)
