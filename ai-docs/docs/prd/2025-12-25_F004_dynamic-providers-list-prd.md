---
feature_id: "F004"
feature_name: "dynamic-providers-list"
title: "Динамический список провайдеров во всех сервисах"
created: "2025-12-25"
author: "AI (Analyst)"
type: "prd"
status: "PRD_READY"
version: 1
mode: "FEATURE"
related_features: ["F003"]
services: ["free-ai-selector-telegram-bot", "free-ai-selector-business-api", "free-ai-selector-health-worker"]
requirements_count: 7
---

# PRD: Динамический список провайдеров во всех сервисах

**Feature ID**: F004
**Версия**: 1.0
**Дата**: 2025-12-25
**Автор**: AI Agent (Аналитик)
**Статус**: PRD_READY

---

## 1. Обзор

### 1.1 Проблема

После расширения системы до 16 провайдеров (F003) обнаружено, что многие места в коде всё ещё показывают/тестируют только 6 оригинальных провайдеров:

- **Telegram бот `/start`**: показывает список из 6 провайдеров (строки 143-149)
- **Telegram бот `/help`**: упоминает "6 провайдерам" (строка 183)
- **test_all_providers.py**: тестирует только 6 провайдеров (строки 52-60, 237-245)
- **health-worker/main.py**: if/elif chain только для 6 провайдеров (строки 308-322)

Это приводит к:
- Дезинформации пользователей (видят 6 вместо 16)
- Неполному тестированию новых провайдеров
- Отсутствию мониторинга для 10 новых провайдеров

### 1.2 Решение

Сделать список провайдеров динамическим во всех точках:

1. **Telegram бот**: получать список из API `/api/v1/models/stats`
2. **test_all_providers.py**: синхронизировать со списком в `process_prompt.py`
3. **health-worker**: заменить if/elif на dispatch-словарь с check_* функциями

### 1.3 Целевая аудитория

| Сегмент | Описание | Потребности |
|---------|----------|-------------|
| Пользователи бота | Используют TG бот для AI-запросов | Видеть актуальный список провайдеров |
| Администраторы | Мониторят систему | Тестировать и отслеживать все провайдеры |
| Разработчики | Добавляют новых провайдеров | Автоматическая синхронизация |

### 1.4 Ценностное предложение

- Один источник правды для списка провайдеров
- Автоматическая синхронизация UI с бэкендом
- Полное покрытие тестированием и мониторингом

---

## 2. Функциональные требования

### 2.1 Core Features (Must Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-001 | Динамический /start | Команда `/start` должна показывать актуальный список всех моделей из API | При вызове `/start` отображаются все 16 провайдеров с их моделями |
| FR-002 | Динамическое количество | Текст должен показывать актуальное количество провайдеров | Вместо "6 провайдеров" показывается "{N} провайдеров" |
| FR-003 | Статус активности | Для каждой модели показывать статус активности | Активные модели отмечены ✅, неактивные ⚠️ |
| FR-004 | Синхронизация test_all_providers | Endpoint `/test` должен тестировать все 16 провайдеров | `POST /api/v1/providers/test` возвращает результаты для 16 провайдеров |

### 2.2 Important Features (Should Have)

| ID | Название | Описание | Критерий приёмки |
|----|----------|----------|------------------|
| FR-010 | Health checks для всех | Health-worker должен проверять все 16 провайдеров | Логи показывают проверку всех 16 провайдеров |
| FR-011 | Dispatch-словарь | Заменить if/elif chain на dispatch pattern | Код использует словарь PROVIDER_CHECK_FUNCTIONS |
| FR-012 | Динамический /help | Текст `/help` не должен содержать захардкоженное число провайдеров | В тексте "всем провайдерам" вместо "6 провайдерам" |

### 2.3 Nice to Have (Could Have)

Нет требований в этой категории.

---

## 3. User Stories

### US-001: Пользователь видит все провайдеры

**Как** пользователь Telegram бота
**Я хочу** видеть актуальный список всех AI провайдеров при команде /start
**Чтобы** знать какие модели доступны в системе

**Критерии приёмки:**
- [ ] При вызове /start отображаются все провайдеры из БД
- [ ] Для каждого провайдера показано название модели
- [ ] Активные/неактивные модели визуально различимы

**Связанные требования:** FR-001, FR-003

---

### US-002: Администратор тестирует все провайдеры

**Как** администратор системы
**Я хочу** тестировать все провайдеры через /test
**Чтобы** проверить работоспособность всей системы

**Критерии приёмки:**
- [ ] Команда /test проверяет все 16 провайдеров
- [ ] Результаты показывают статус каждого провайдера
- [ ] Выводится общая статистика (X/16 работают)

**Связанные требования:** FR-004

---

### US-003: Health-worker мониторит всех

**Как** система мониторинга
**Я хочу** проверять здоровье всех провайдеров
**Чтобы** обновлять статистику надёжности для всех моделей

**Критерии приёмки:**
- [ ] Health-worker проверяет все 16 провайдеров
- [ ] Статистика обновляется для всех моделей
- [ ] Неизвестные провайдеры логируются с предупреждением

**Связанные требования:** FR-010, FR-011

---

## 4. UI/UX требования

### 4.1 Telegram Bot Interface

| ID | Экран | Описание | Приоритет |
|----|-------|----------|-----------|
| UI-001 | /start сообщение | Динамический список всех провайдеров с иконками статуса | Must |
| UI-002 | /help сообщение | Без захардкоженных чисел провайдеров | Must |
| UI-003 | /test результаты | Результаты тестирования для всех 16 провайдеров | Must |

### 4.2 Формат списка провайдеров

```
{N} бесплатных AI провайдеров (без кредитной карты):
✅ GoogleGemini - Gemini 2.5 Flash
✅ Groq - Llama 3.3 70B Versatile
⚠️ DeepSeek - DeepSeek-V3 (неактивен)
...
```

---

## 5. Нефункциональные требования

### 5.1 Производительность

| ID | Метрика | Требование | Измерение |
|----|---------|------------|-----------|
| NF-001 | Время /start | < 2s | Включая вызов API models/stats |
| NF-002 | Время /test | < 120s | Тестирование всех 16 провайдеров |

### 5.2 Надёжность

| ID | Требование | Описание |
|----|------------|----------|
| NF-010 | Fallback для /start | Если API недоступен, показать fallback сообщение |
| NF-011 | Graceful degradation | Неизвестные провайдеры пропускаются с логом |

---

## 6. Технические ограничения

### 6.1 Обязательные технологии

- **Backend**: Python 3.11+, FastAPI
- **Telegram Bot**: aiogram 3.x
- **HTTP Client**: httpx

### 6.2 Файлы для изменения

| Файл | Изменения |
|------|-----------|
| `services/free-ai-selector-telegram-bot/app/main.py` | cmd_start, cmd_help |
| `services/free-ai-selector-business-api/app/application/use_cases/test_all_providers.py` | providers dict, model_names |
| `services/free-ai-selector-health-worker/app/main.py` | check_* функции, dispatch |

### 6.3 Без изменений

| Компонент | Причина |
|-----------|---------|
| База данных | Все 16 моделей уже есть после F003 |
| Data API | Endpoint `/api/v1/models/stats` уже возвращает все модели |
| seed.py | Модели уже добавлены |

---

## 7. Допущения и риски

### 7.1 Допущения

| # | Допущение | Влияние если неверно |
|---|-----------|---------------------|
| 1 | API `/api/v1/models/stats` работает стабильно | /start будет показывать fallback |
| 2 | Все провайдеры имеют аналогичный API формат | Нужны индивидуальные check_* функции |

### 7.2 Риски

| # | Риск | Вероятность | Влияние | Митигация |
|---|------|-------------|---------|-----------|
| 1 | Timeout при запросе stats | Low | Low | Fallback сообщение |
| 2 | Новый провайдер без check_* | Med | Med | Логировать warning, пропустить |

---

## 8. Открытые вопросы

| # | Вопрос | Статус | Ответственный | Решение |
|---|--------|--------|--------------|---------|
| — | — | — | — | Нет открытых вопросов |

---

## 9. Глоссарий

| Термин | Определение |
|--------|-------------|
| Провайдер | AI-сервис предоставляющий модели (Groq, Cerebras, etc.) |
| Health check | Проверка работоспособности провайдера |
| Dispatch pattern | Паттерн замены if/elif на словарь функций |

---

## 10. История изменений

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2025-12-25 | AI Analyst | Первоначальная версия |

---

## Качественные ворота

### PRD_READY Checklist

- [x] Все секции заполнены
- [x] Требования имеют уникальные ID (FR-*, NF-*, UI-*)
- [x] Критерии приёмки определены для каждого требования
- [x] User stories связаны с требованиями
- [x] Нет блокирующих открытых вопросов
- [x] Риски идентифицированы и имеют план митигации
