---
feature_id: "F001"
feature_name: "project-cleanup-audit"
title: "Аудит и очистка проекта Free AI Selector"
created: "2025-12-23"
author: "AI (Analyst)"
type: "prd"
status: "PRD_READY"
version: 1
migrated_from: "project-cleanup-audit-prd.md"
migrated_at: "2025-12-23"
---
# PRD: Аудит и очистка проекта Free AI Selector

**Версия**: 1.0
**Дата**: 2025-12-23
**Автор**: AI Agent (Аналитик)
**Статус**: Draft

---

## 1. Обзор

### 1.1 Проблема

Проект Free AI Selector накопил технический долг:
- Устаревшие файлы, ссылающиеся на несуществующие ресурсы
- Мёртвый код и неиспользуемые функции
- Дублирование утилит между сервисами
- Нарушения архитектурных принципов DDD/Hexagonal
- Неполное тестовое покрытие в некоторых сервисах

### 1.2 Решение

Провести комплексную очистку проекта:
1. Удалить устаревшие и неиспользуемые файлы
2. Устранить дублирование кода
3. Удалить мёртвый код внутри файлов
4. Обновить документацию с устаревшими ссылками
5. Документировать архитектурные проблемы для будущего рефакторинга

### 1.3 Цель проекта

> **Free AI Selector** — платформа маршрутизации AI на основе надёжности.
> Автоматически выбирает лучшую бесплатную AI-модель по формуле:
> `reliability_score = (success_rate × 0.6) + (speed_score × 0.4)`

---

## 2. Результаты анализа

### 2.1 Общая структура проекта

```
free-ai-selector/
├── services/                      # 5 микросервисов ✅
│   ├── aimanager_business_api/    # Бизнес-логика (FastAPI)
│   ├── aimanager_data_postgres_api/ # Data API (PostgreSQL)
│   ├── aimanager_telegram_bot/    # Telegram интерфейс
│   ├── aimanager_health_worker/   # Мониторинг здоровья
│   └── aimanager_nginx/           # Reverse proxy
├── shared/                        # Общие утилиты ⚠️ НЕ ИСПОЛЬЗУЕТСЯ
├── ai-docs/                       # AIDD артефакты
├── .aidd/                         # AIDD фреймворк (submodule)
├── .claude/                       # Claude Code команды
├── docker-compose.yml             # Оркестрация ✅
├── Makefile                       # Dev команды ✅
├── CLAUDE.md                      # Инструкции AI ✅
└── [документация]                 # README, guides
```

---

## 3. Функциональные требования (Очистка)

### FR-001: Удаление неиспользуемой директории shared/

| Поле | Значение |
|------|----------|
| **ID** | FR-001 |
| **Название** | Удалить директорию shared/ |
| **Описание** | Директория `shared/utils/security.py` НЕ импортируется ни одним сервисом. Каждый сервис имеет локальную копию. |
| **Приоритет** | Must |
| **Критерий приёмки** | Директория `shared/` удалена из репозитория |

**Доказательство неиспользования:**
```bash
grep -r "from shared\|import shared" .  # Результат: пусто
```

---

### FR-002: Удаление устаревшего файла PROMPT_FOR_AI_GENERATION.md

| Поле | Значение |
|------|----------|
| **ID** | FR-002 |
| **Название** | Удалить PROMPT_FOR_AI_GENERATION.md |
| **Описание** | Файл (1021 строка) — исторический промпт для генерации проекта. Ссылается на несуществующий `.ai-framework/`. Информация дублируется в CLAUDE.md и README.md. |
| **Приоритет** | Must |
| **Критерий приёмки** | Файл удалён из репозитория |

**Устаревшие ссылки в файле:**
```
.ai-framework/AGENTS.md (не существует)
.ai-framework/docs/guides/prompt-validation-guide.md (не существует)
```

---

### FR-003: Обновление README.md — удаление устаревших ссылок

| Поле | Значение |
|------|----------|
| **ID** | FR-003 |
| **Название** | Исправить ссылки в README.md |
| **Описание** | README содержит 6+ ссылок на несуществующий `.ai-framework/`. Нужно заменить на `.aidd/` или удалить. |
| **Приоритет** | Must |
| **Критерий приёмки** | Все ссылки в README.md ведут на существующие файлы |

**Проблемные строки:**
```markdown
[![Framework](https://img.shields.io/badge/framework-.ai--framework-purple.svg)](.ai-framework/)
[.ai-framework/docs](.ai-framework/docs/)
[AI Code Generation Master Workflow](.ai-framework/docs/guides/...)
```

---

### FR-004: Удаление мёртвой функции is_sensitive_key_present()

| Поле | Значение |
|------|----------|
| **ID** | FR-004 |
| **Название** | Удалить is_sensitive_key_present() из security.py |
| **Описание** | Функция определена в 4 местах, но НЕ вызывается ни разу. |
| **Приоритет** | Should |
| **Критерий приёмки** | Функция удалена из всех security.py или задокументировано её предназначение |

**Затронутые файлы:**
- `services/aimanager_business_api/app/utils/security.py`
- `services/aimanager_data_postgres_api/app/utils/security.py`
- `services/aimanager_telegram_bot/app/utils/security.py`
- `services/aimanager_health_worker/app/utils/security.py`

---

### FR-005: Удаление неиспользуемого импорта Decimal

| Поле | Значение |
|------|----------|
| **ID** | FR-005 |
| **Название** | Удалить неиспользуемый импорт Decimal |
| **Описание** | В `aimanager_health_worker/app/main.py` импортирован `Decimal`, но не используется |
| **Приоритет** | Should |
| **Критерий приёмки** | Импорт `from decimal import Decimal` удалён из main.py |

---

### FR-006: Удаление дублирующихся локальных импортов в Data API

| Поле | Значение |
|------|----------|
| **ID** | FR-006 |
| **Название** | Исправить дублирование импортов в models.py |
| **Описание** | В `aimanager_data_postgres_api/app/api/v1/models.py` импорты `datetime` и `Decimal` дублируются внутри функций (строки 99-100, 181, 219) |
| **Приоритет** | Should |
| **Критерий приёмки** | Локальные импорты удалены, глобальные импорты добавлены в начало файла |

---

### FR-007: Проверка файла deploy.sh

| Поле | Значение |
|------|----------|
| **ID** | FR-007 |
| **Название** | Проверить актуальность deploy.sh |
| **Описание** | Скрипт деплоя требует проверки — возможно устарел |
| **Приоритет** | Could |
| **Критерий приёмки** | Скрипт актуализирован или удалён с пометкой в документации |

---

## 4. Нефункциональные требования (Архитектурные проблемы)

### NF-001: Telegram Bot — нарушение DDD архитектуры

| Поле | Значение |
|------|----------|
| **ID** | NF-001 |
| **Название** | Telegram Bot требует рефакторинга |
| **Описание** | Весь код (411 строк) находится в main.py. Отсутствуют слои: api/, application/, domain/, infrastructure/. Пустые директории handlers/ и infrastructure/. |
| **Метрика** | Текущее: 1 файл / Требуется: минимум 5 файлов в соответствии с DDD |
| **Приоритет** | Future (не в рамках этой очистки) |

---

### NF-002: Telegram Bot — отсутствие тестов

| Поле | Значение |
|------|----------|
| **ID** | NF-002 |
| **Название** | Telegram Bot: 0% тестового покрытия |
| **Описание** | Требование проекта — ≥75% покрытия. Telegram Bot имеет 0%. |
| **Метрика** | Текущее: 0% / Требуется: ≥75% |
| **Приоритет** | Future (не в рамках этой очистки) |

---

### NF-003: Data API — отсутствие Application слоя

| Поле | Значение |
|------|----------|
| **ID** | NF-003 |
| **Название** | Data API: бизнес-логика в routes |
| **Описание** | В Data API отсутствует слой application/use_cases/. Бизнес-логика находится непосредственно в HTTP routes. |
| **Метрика** | Соответствие DDD: 70% |
| **Приоритет** | Future (не в рамках этой очистки) |

---

### NF-004: Дублирование security.py между сервисами

| Поле | Значение |
|------|----------|
| **ID** | NF-004 |
| **Название** | Консолидировать security.py |
| **Описание** | Идентичный файл security.py (155 строк) скопирован в 4 сервиса. Варианты решения: 1) Создать общий пакет 2) Вынести в shared/ с правильными импортами 3) Оставить как есть (микросервисная независимость) |
| **Метрика** | 4 копии × 155 строк = 620 строк дублирования |
| **Приоритет** | Future (требует архитектурного решения) |

---

## 5. Сводка файлов для удаления

| # | Путь | Размер | Причина удаления |
|---|------|--------|------------------|
| 1 | `shared/` (вся директория) | 2 файла | Не используется ни одним сервисом |
| 2 | `PROMPT_FOR_AI_GENERATION.md` | 1021 строк | Устаревший, ссылки на несуществующие файлы |

---

## 6. Сводка файлов для редактирования

| # | Путь | Изменение |
|---|------|-----------|
| 1 | `README.md` | Удалить/заменить ссылки на `.ai-framework/` |
| 2 | `services/*/app/utils/security.py` (×4) | Удалить функцию `is_sensitive_key_present()` |
| 3 | `services/aimanager_health_worker/app/main.py` | Удалить `from decimal import Decimal` |
| 4 | `services/aimanager_data_postgres_api/app/api/v1/models.py` | Исправить дублирующиеся локальные импорты |

---

## 7. Открытые вопросы

| # | Вопрос | Статус |
|---|--------|--------|
| 1 | Сохранить ли файлы API_EXAMPLES.md и API_KEY_SETUP_GUIDE.md? | **Рекомендация**: Сохранить — актуальная документация |
| 2 | Сохранить ли файл DEVELOPMENT.md? | Требует проверки актуальности |
| 3 | Нужен ли рефакторинг Telegram Bot в этой итерации? | **Рекомендация**: Отложить — требует значительных усилий |
| 4 | Консолидировать ли security.py или оставить копии? | **Рекомендация**: Оставить копии (микросервисная независимость) |

---

## 8. Матрица трассировки

| Требование | Файлы | Действие | Риск |
|------------|-------|----------|------|
| FR-001 | shared/ | Удалить | Низкий |
| FR-002 | PROMPT_FOR_AI_GENERATION.md | Удалить | Низкий |
| FR-003 | README.md | Редактировать | Низкий |
| FR-004 | security.py (×4) | Редактировать | Низкий |
| FR-005 | aimanager_health_worker/main.py | Редактировать | Низкий |
| FR-006 | aimanager_data_postgres_api/models.py | Редактировать | Средний |
| FR-007 | deploy.sh | Проверить | Низкий |

---

## 9. План действий (рекомендуемый порядок)

### Этап 1: Удаление (безопасно)
1. ✅ Удалить `shared/` директорию
2. ✅ Удалить `PROMPT_FOR_AI_GENERATION.md`

### Этап 2: Редактирование документации
3. Обновить `README.md` — заменить ссылки `.ai-framework/` → `.aidd/` или удалить

### Этап 3: Очистка кода
4. Удалить `is_sensitive_key_present()` из всех security.py
5. Удалить неиспользуемый импорт Decimal в health_worker
6. Исправить дублирующиеся импорты в Data API

### Этап 4: Проверка
7. Запустить тесты: `make test`
8. Проверить здоровье: `make health`
9. Проверить сборку: `make build`

---

## 10. Метрики успеха

| Метрика | До очистки | После очистки |
|---------|------------|---------------|
| Файлов с устаревшими ссылками | 2+ | 0 |
| Неиспользуемых директорий | 1 (shared/) | 0 |
| Строк мёртвого кода | ~200 | 0 |
| Дублирующихся импортов | 3 | 0 |

---

**Статус документа**: Готов к утверждению
**Следующий шаг**: `/aidd-research` для детального анализа перед выполнением
