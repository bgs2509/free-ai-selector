---
feature_id: "F002"
feature_name: "web-ui"
title: "Исследование: Веб-интерфейс для Free AI Selector"
created: "2025-12-25"
author: "AI (Researcher)"
type: "_research"
status: "RESEARCH_DONE"
version: 1
mode: "FEATURE"
---

# Отчёт исследования: F002 Web UI

**Feature ID**: F002
**Дата**: 2025-12-25
**Автор**: AI Agent (Исследователь)
**Статус**: RESEARCH_DONE

---

## 1. Анализ существующего кода

### 1.1 Структура Business API

```
services/free-ai-selector-business-api/
├── app/
│   ├── api/v1/
│   │   ├── models.py      # GET /api/v1/models/stats
│   │   ├── prompts.py     # POST /api/v1/prompts/process
│   │   ├── providers.py   # POST /api/v1/providers/test
│   │   └── schemas.py     # Pydantic модели
│   ├── application/use_cases/
│   ├── domain/
│   ├── infrastructure/
│   │   ├── ai_providers/  # 6 провайдеров
│   │   └── http_clients/
│   └── main.py            # FastAPI app, точка модификации
├── tests/
├── Dockerfile
└── requirements.txt
```

### 1.2 Конфигурация FastAPI (main.py)

**Ключевые настройки:**

| Параметр | Значение | Описание |
|----------|----------|----------|
| `ROOT_PATH` | `os.getenv("ROOT_PATH", "")` | Для nginx-proxy: `/free-ai-selector` |
| `CORS_ORIGINS` | `http://localhost:3000,http://localhost:8000` | Разрешённые origins |
| `docs_url` | `/docs` | Swagger UI |
| `redoc_url` | `/redoc` | ReDoc |

**Текущий root endpoint (`GET /`):**
```python
@app.get("/", tags=["Root"])
async def root(request: Request):
    return {
        "service": SERVICE_NAME,
        "version": SERVICE_VERSION,
        "environment": ENVIRONMENT,
        "docs": "/docs",
        "health": "/health",
    }
```

### 1.3 API Schemas для JS интеграции

**ProcessPromptRequest:**
```json
{"prompt": "string (1-10000 символов)"}
```

**ProcessPromptResponse:**
```json
{
  "prompt": "string",
  "response": "string",
  "selected_model": "string",
  "provider": "string",
  "response_time_seconds": "decimal",
  "success": "boolean"
}
```

**ModelsStatsResponse:**
```json
{
  "models": [
    {
      "id": "int",
      "name": "string",
      "provider": "string",
      "reliability_score": "float",
      "success_rate": "float",
      "average_response_time": "float",
      "total_requests": "int",
      "is_active": "boolean"
    }
  ],
  "total_models": "int"
}
```

**Providers Test Response:**
```json
{
  "total_providers": 6,
  "successful": 4,
  "failed": 2,
  "results": [
    {
      "provider": "string",
      "model": "string",
      "status": "success|error",
      "response_time": "float|null",
      "error": "string|null"
    }
  ]
}
```

**HealthCheckResponse:**
```json
{
  "status": "healthy|unhealthy",
  "service": "string",
  "version": "string",
  "data_api_connection": "string"
}
```

---

## 2. Выявленные паттерны

### 2.1 Архитектурные паттерны

| Паттерн | Описание |
|---------|----------|
| **DDD/Hexagonal** | Слоистая архитектура: api → application → domain → infrastructure |
| **HTTP-only** | Business API обращается к Data API только через HTTP |
| **Request ID tracking** | Middleware добавляет `X-Request-ID` ко всем запросам |
| **Rate Limiting** | slowapi для ограничения запросов |

### 2.2 Паттерн обработки ошибок

```python
try:
    # Бизнес-логика
except Exception as e:
    logger.error(f"Error: {sanitize_error_message(e)}")
    raise HTTPException(status_code=500, detail=f"Error: {sanitize_error_message(e)}")
finally:
    await data_api_client.close()
```

### 2.3 Docker конфигурация

- **Volume mount**: `/app` — для hot-reload в development
- **proxy-network**: Business API подключен к внешней сети nginx-proxy
- **ROOT_PATH**: Передаётся через env для работы за reverse proxy

---

## 3. Точки расширения

### 3.1 Добавление Static Files

**FastAPI поддерживает StaticFiles mount:**
```python
from fastapi.staticfiles import StaticFiles

app.mount("/static", StaticFiles(directory="app/static"), name="static")
```

**Важно**: Mount статики должен быть **после** API роутеров, но **до** изменения корневого маршрута.

### 3.2 Изменение корневого маршрута

**Текущее поведение**: `GET /` возвращает JSON с информацией о сервисе.

**Требуемое поведение**: `GET /` редиректит на `/static/index.html`.

**Варианты реализации:**

1. **RedirectResponse** (рекомендуется):
```python
from fastapi.responses import RedirectResponse

@app.get("/", include_in_schema=False)
async def root():
    return RedirectResponse(url="/static/index.html")
```

2. **FileResponse** (альтернатива):
```python
from fastapi.responses import FileResponse

@app.get("/", include_in_schema=False)
async def root():
    return FileResponse("app/static/index.html")
```

### 3.3 ROOT_PATH для static files

**Проблема**: При работе за nginx-proxy с `ROOT_PATH=/free-ai-selector`:
- API доступен по: `https://server/free-ai-selector/api/v1/...`
- Static должны быть по: `https://server/free-ai-selector/static/...`

**Решение**: FastAPI `root_path` автоматически применяется ко всем маршрутам.

**В JavaScript**: Использовать относительные пути или динамически определять BASE_URL:
```javascript
// Вариант 1: Относительные пути
const API_BASE = '';  // Пустая строка для same-origin

// Вариант 2: Из meta-тега
const API_BASE = document.querySelector('meta[name="api-base"]')?.content || '';
```

---

## 4. Технические ограничения

### 4.1 CORS

**Текущая конфигурация:**
```python
CORS_ORIGINS = os.getenv("CORS_ORIGINS", "http://localhost:3000,http://localhost:8000").split(",")
```

**Для static files**: CORS **не требуется** при same-origin запросах (static и API на одном домене).

### 4.2 Dockerfile

**Текущий**: Копирует весь `app/` при сборке.
**Изменения не требуются**: `app/static/` будет скопирован автоматически.

### 4.3 Volume mount в docker-compose

```yaml
volumes:
  - ./services/free-ai-selector-business-api:/app
```
**Hot-reload работает**: Изменения в `static/` будут видны без пересборки.

---

## 5. Рекомендации по интеграции

### 5.1 Структура файлов

```
app/
├── static/                    # Новая директория
│   ├── index.html            # Главная страница
│   ├── style.css             # Стили
│   └── app.js                # JavaScript логика
└── main.py                   # Модификация
```

### 5.2 Модификации main.py

**Добавить импорты:**
```python
from fastapi.staticfiles import StaticFiles
from fastapi.responses import RedirectResponse
import os
```

**Добавить mount статики (после создания app, перед роутерами):**
```python
# Монтируем static files
static_dir = os.path.join(os.path.dirname(__file__), "static")
if os.path.exists(static_dir):
    app.mount("/static", StaticFiles(directory=static_dir), name="static")
```

**Изменить root endpoint:**
```python
@app.get("/", include_in_schema=False)
async def root():
    """Перенаправление на веб-интерфейс."""
    return RedirectResponse(url="/static/index.html")
```

### 5.3 JavaScript: API вызовы

**Рекомендуемый паттерн:**
```javascript
// Базовый URL (пустой для same-origin)
const API_BASE = '';

// Функция для API вызовов
async function apiCall(endpoint, options = {}) {
    const response = await fetch(`${API_BASE}${endpoint}`, {
        headers: {
            'Content-Type': 'application/json',
            ...options.headers
        },
        ...options
    });

    if (!response.ok) {
        const error = await response.json();
        throw new Error(error.detail || 'Ошибка API');
    }

    return response.json();
}

// Примеры использования:
// apiCall('/api/v1/prompts/process', { method: 'POST', body: JSON.stringify({prompt}) })
// apiCall('/api/v1/models/stats')
// apiCall('/api/v1/providers/test', { method: 'POST' })
// apiCall('/health')
```

### 5.4 HTML: Meta-теги для SEO и PWA

```html
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Рейтинг бесплатных ИИ моделей - автоматический выбор лучшей модели">
<meta name="theme-color" content="#0066ff">
<title>Рейтинг бесплатных ИИ моделей</title>
```

### 5.5 CSS: Минималистичная стилистика

На основе анализа скриншотов существующих сервисов:

```css
/* Переменные */
:root {
    --primary-color: #0066ff;
    --bg-color: #ffffff;
    --text-color: #333333;
    --border-color: #e0e0e0;
    --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Карточки */
.card {
    background: var(--bg-color);
    border-radius: 8px;
    box-shadow: var(--shadow);
    padding: 24px;
    margin-bottom: 24px;
}

/* Кнопки */
.btn-primary {
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 4px;
    cursor: pointer;
}
```

---

## 6. Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| ROOT_PATH не применяется к static | Low | Med | Тестирование за nginx-proxy перед деплоем |
| Конфликт маршрутов `/` | Low | Med | mount статики перед роутерами, root endpoint с `include_in_schema=False` |
| Кэширование браузером | Med | Low | Версионирование static файлов или no-cache headers |

---

## 7. Чеклист готовности

- [x] Структура Business API изучена
- [x] API endpoints и schemas документированы
- [x] CORS и ROOT_PATH конфигурация проанализирована
- [x] Точки расширения определены
- [x] Технические ограничения выявлены
- [x] Рекомендации по интеграции сформулированы
- [x] Риски идентифицированы

---

## 8. Следующий шаг

После прохождения ворот `RESEARCH_DONE`:

```bash
/aidd-feature-plan
```

---

## Качественные ворота

### RESEARCH_DONE Checklist

- [x] Существующий код проанализирован
- [x] Архитектурные паттерны выявлены и описаны
- [x] Технические ограничения определены
- [x] Рекомендации по интеграции сформулированы
- [x] Отчёт исследования сохранён
