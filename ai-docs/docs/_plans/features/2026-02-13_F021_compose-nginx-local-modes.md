# План фичи: F021 — два независимых compose-режима (`nginx` и `loc`)

**Feature ID**: F021
**Дата**: 2026-02-13
**Статус**: Draft (ожидает утверждения)
**Режим**: FEATURE
**Связанные артефакты**:
- PRD: `_analysis/2026-02-13_F021_compose-nginx-local-modes.md`
- Research: `_research/2026-02-13_F021_compose-nginx-local-modes.md`

---

## 1. Обзор

Цель фичи: упростить и сделать предсказуемым запуск проекта в двух средах без override-механики:
1. `nginx` режим для VPS (текущая модель за reverse proxy).
2. `loc` режим для локальной разработки без nginx.

Ключевая архитектурная договорённость:
- использовать два **независимых** compose-файла;
- использовать явные команды `make nginx` и `make loc`;
- сохранить `make up` как обратную совместимость (`make up` -> nginx);
- вносить подробные комментарии в код и конфиги с объяснением "почему именно так".

### 1.1 Scope

**В scope:**
- переименование `docker-compose.yml` в `docker-compose.nginx.yml`;
- создание нового `docker-compose.loc.yml` как самостоятельной локальной конфигурации;
- обновление `Makefile` под выбор режима;
- корректировка `ROOT_PATH/openapi_url` (Data API) и `API_BASE` (Web UI);
- обновление документации запуска;
- удаление `scripts/deploy.sh` (уже выполнено) и фиксация единого операционного входа через `make nginx`.

**Вне scope:**
- изменения бизнес-логики выбора AI моделей;
- изменения API контрактов (кроме маршрутизации docs/openapi path);
- добавление новых внешних зависимостей.

---

## 2. Анализ существующего кода

### 2.1 Затронутые сервисы и файлы

| Сервис/область | Изменение | Комментарий |
|---|---|---|
| Root compose config | Да | Переименование base-конфига в `docker-compose.nginx.yml` |
| Local compose config | Да | Новый `docker-compose.loc.yml` без `proxy-network` |
| `Makefile` | Да | Явные режимы `nginx`/`loc`, mode-aware команды |
| Business API (`app/main.py`) | Нет/минимум | ROOT_PATH уже динамический, проверить совместимость |
| Data API (`app/main.py`) | Да | Выравнивание `openapi_url` под `ROOT_PATH` |
| Web UI (`app/static/index.html`) | Да | Универсальный расчёт `API_BASE`, без хардкода `/free-ai-selector/` |
| Документация (`README`, `docs/operations/*`) | Да | Новый запуск через `make nginx`/`make loc` |
| `scripts/deploy.sh` | Удалён | Операционный вход стандартизируется через Makefile |

### 2.2 Точки интеграции

| Точка | Текущее состояние | План |
|---|---|---|
| Compose entrypoint | `docker-compose.yml` | `docker-compose.nginx.yml` и `docker-compose.loc.yml` |
| Локальные docs URL | Не гарантированы | В `loc` режиме открываются `localhost:8000/docs` и `localhost:8001/docs` |
| Proxy-network зависимость | Есть в текущем compose | Сохраняется только в nginx-режиме |
| Data API openapi URL | Статичный `/openapi.json` | Делается динамическим от `ROOT_PATH` |
| UI API_BASE | Хардкод префикса | Вычисление по фактическому URL-пути |

---

## 3. План изменений

### Шаг 1: Разделить compose на два независимых файла

**Файлы:**
- `docker-compose.nginx.yml` (переименованный текущий compose)
- `docker-compose.loc.yml` (новый локальный файл)

**План:**
1. Переименовать текущий файл как есть в `docker-compose.nginx.yml`.
2. Создать `docker-compose.loc.yml` как самостоятельный compose, не через override.
3. В локальном файле:
   - не использовать `proxy-network`;
   - публиковать порты `8000:8000` и `8001:8001`;
   - явно фиксировать пустой `ROOT_PATH` для Business/Data API.

**Требование к комментариям:**
- в обоих файлах добавить подробные комментарии на русском:
  - почему файлы разделены;
  - почему в nginx-режиме нет публикации портов;
  - почему в loc-режиме порты публикуются;
  - почему `ROOT_PATH` в `loc` должен быть пустым.

### Шаг 2: Сделать `Makefile` mode-aware и добавить команды `nginx`/`loc`

**Файл:** `Makefile`

**План:**
1. Добавить цели `make nginx` и `make loc` как основные команды поднятия сервера.
2. Сохранить `make up` как алиас на `make nginx`.
3. Привести команды `down`, `logs`, `status`, `health`, `migrate`, `seed`, shell-команды к работе с выбранным compose-файлом режима.
4. Минимизировать магию: простой и явный выбор файла режима.

**Требование к комментариям:**
- в `Makefile` добавить развёрнутые комментарии:
  - почему `up` ведёт на `nginx`;
  - почему режим выбирается явно;
  - почему локальный режим отделён от VPS-режима.

### Шаг 3: Выровнять обработку `ROOT_PATH` и docs/openapi

**Файлы:**
- `services/free-ai-selector-data-postgres-api/app/main.py`
- `services/free-ai-selector-business-api/app/static/index.html`

**План:**
1. Data API:
   - сделать `openapi_url` динамическим на основе `ROOT_PATH` по схеме Business API.
2. Web UI:
   - заменить хардкод `'/free-ai-selector/'` на вычисление префикса по текущему URL;
   - проверить, что `API Docs` ссылка и API-вызовы корректны и в `/`, и в префиксном пути.

**Требование к комментариям:**
- подробно объяснить:
  - почему выбрано вычисление префикса из URL, а не хардкод;
  - почему dynamic `openapi_url` нужен для обоих API.

### Шаг 4: Обновить документацию под два режима

**Файлы (минимум):**
- `README.md`
- `docs/operations/quick-start.md`
- `docs/operations/deployment.md`
- `docs/operations/development.md`
- `docs/operations/troubleshooting.md`

**План:**
1. Обновить инструкции запуска на `make nginx` / `make loc`.
2. Обновить упоминания `docker-compose.yml` на новый режимный подход.
3. Явно указать expected URL для каждого режима.
4. Удалить/обновить ссылки на `scripts/deploy.sh`.

### Шаг 5: Проверка и валидация

**Smoke-план:**
1. `make nginx`: сервисы поднимаются, direct-доступ к `localhost:8000` не является обязательным контрактом.
2. `make loc`: доступны
   - `http://localhost:8000/health`
   - `http://localhost:8000/docs`
   - `http://localhost:8001/health`
   - `http://localhost:8001/docs`
3. UI ссылка `API Docs` корректна в обоих режимах.
4. Проверка отсутствия регрессии внутренних связей между сервисами.

---

## 4. API контракты

Функциональные API контракты не меняются.

Изменяется только поведение URL документации в зависимости от режима/префикса:
- `docs` и `openapi.json` должны корректно работать и с `ROOT_PATH`, и без него.

---

## 5. Breaking changes и миграции

- Breaking changes: **нет** на уровне API.
- Операционные изменения: **есть**
  - переименование `docker-compose.yml` -> `docker-compose.nginx.yml`;
  - удаление `scripts/deploy.sh`.
- Миграции БД: **не требуются**.
- Новые зависимости: **не требуются**.

---

## 6. План интеграции

| # | Шаг | Зависимости | Результат |
|---|---|---|---|
| 1 | Переименование compose + создание loc compose | — | Два независимых файла режимов |
| 2 | Makefile `nginx`/`loc` + mode-aware команды | Шаг 1 | Единый и понятный запуск |
| 3 | ROOT_PATH/docs правки в Data API + UI | Шаг 2 | Корректные docs/openapi в обоих режимах |
| 4 | Обновление документации | Шаги 1-3 | Актуальные инструкции |
| 5 | Smoke-проверки | Шаги 1-4 | Подтверждена работоспособность и обратная совместимость |

---

## 7. Риски и митигация

| Риск | Вероятность | Митигация |
|---|---|---|
| Рассинхронизация `docker-compose.nginx.yml` и `docker-compose.loc.yml` | Medium | Подробные комментарии + явная секция различий в документации |
| Привычные команды команды/CI ломаются после переименования compose | Medium | Сохранить `make up` как алиас на nginx + обновить docs |
| Ошибка в расчёте `API_BASE` для нестандартного префикса | Medium | Вычисление префикса из URL + smoke-проверки в обоих режимах |
| Регрессия docs/openapi в Data API | Medium | Использовать ту же динамическую схему, что в Business API |
| Потеря отдельного deploy workflow после удаления `deploy.sh` | Low | Явно закрепить деплой через `make nginx` и mode-aware команды |

---

## 8. Проверки готовности к `aidd-code`

- [x] Интеграция с существующим кодом описана
- [x] Изменения по файлам и шагам определены
- [x] Breaking changes и операционные изменения описаны
- [x] Миграции БД не требуются (зафиксировано)
- [x] План-файл создан в правильной папке (`_plans/features/`)
- [ ] План утверждён пользователем (ожидается)

---

## 9. Следующий шаг

После утверждения плана:

```bash
/aidd-code
```
