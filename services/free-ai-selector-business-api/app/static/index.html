<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free AI Selector - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ª—É—á—à–µ–π AI –º–æ–¥–µ–ª–∏">
    <meta name="theme-color" content="#0066ff">
    <title>Free AI Selector</title>
    <style>
        :root {
            --primary: #0066ff;
            --primary-hover: #0052cc;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #333333;
            --text-light: #666666;
            --text-muted: #999999;
            --border: #e0e0e0;
            --success: #22c55e;
            --error: #ef4444;
            --shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
        }
        .page-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 40px;
            width: 100%;
            max-width: 600px;
        }
        .title { font-size: 32px; font-weight: 600; color: var(--text); margin-bottom: 8px; }
        .subtitle { font-size: 16px; color: var(--text-light); margin-bottom: 32px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
        .tab {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px 20px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
        }
        .tab:hover { border-color: var(--primary); color: var(--primary); }
        .tab.active { background: var(--primary); border-color: var(--primary); color: white; }
        .tab-content { min-height: 200px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }
        textarea {
            width: 100%;
            padding: 16px;
            border: 2px dashed var(--border);
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            transition: border-color 0.2s;
            margin-bottom: 16px;
        }
        textarea:focus { outline: none; border-color: var(--primary); border-style: solid; }
        textarea::placeholder { color: var(--text-muted); }
        .format-selector { margin-bottom: 16px; }
        .format-label { display: block; font-size: 14px; font-weight: 500; color: var(--text); margin-bottom: 8px; }
        .radio-group { display: flex; gap: 12px; }
        .radio-option { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; color: var(--text-light); }
        .radio-option input { cursor: pointer; }
        .model-selector { margin-bottom: 16px; }
        .model-select-row { display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .model-select {
            flex: 1;
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text);
            font-size: 14px;
        }
        .model-select:focus { outline: none; border-color: var(--primary); }
        .model-help { margin-top: 6px; font-size: 12px; color: var(--text-muted); }
        .btn-primary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 14px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover { background: var(--primary-hover); }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-icon {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-icon:hover { border-color: var(--primary); color: var(--primary); }
        .response-box {
            margin-top: 20px;
            padding: 16px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 4px solid var(--primary);
        }
        .response-meta { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px; }
        .tag { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; background: var(--primary); color: white; }
        .tag-gray { background: var(--text-light); }
        .tag-blue { background: #0ea5e9; }
        .response-text { font-size: 15px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; color: var(--text); }
        .error-box {
            margin-top: 16px;
            padding: 12px 16px;
            background: #fef2f2;
            border: 1px solid var(--error);
            border-radius: 6px;
            color: var(--error);
            font-size: 14px;
        }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .section-title { font-size: 14px; font-weight: 500; color: var(--text-light); }
        .hint { font-size: 14px; color: var(--text-muted); margin-bottom: 16px; }
        .stats-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .stats-table th, .stats-table td { padding: 12px 8px; text-align: left; border-bottom: 1px solid var(--border); }
        .stats-table th { font-weight: 600; color: var(--text-light); font-size: 12px; text-transform: uppercase; }
        .stats-table tbody tr:hover { background: #f8fafc; }
        .stats-table .rank-cell { text-align: center; width: 50px; }
        .stats-table .score-cell { font-weight: 600; color: var(--primary); }
        .status-active { color: var(--success); font-weight: 500; }
        .status-inactive { color: var(--error); font-weight: 500; }
        .medal { font-size: 16px; }
        .providers-results { margin-top: 20px; }
        .providers-summary { padding: 12px 16px; background: #f8fafc; border-radius: 6px; margin-bottom: 12px; font-weight: 500; font-size: 14px; }
        .providers-list { display: flex; flex-direction: column; gap: 8px; }
        .provider-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #f8fafc;
            border-radius: 6px;
            border-left: 3px solid var(--border);
        }
        .provider-item.success { border-left-color: var(--success); }
        .provider-item.error { border-left-color: var(--error); }
        .provider-info { display: flex; flex-direction: column; gap: 2px; }
        .provider-name { font-weight: 500; font-size: 14px; }
        .provider-model { font-size: 12px; color: var(--text-muted); }
        .provider-status { display: flex; align-items: center; gap: 8px; }
        .provider-time { font-size: 13px; color: var(--text-light); }
        .provider-error { font-size: 12px; color: var(--error); max-width: 180px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .loader {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }
        .loader-dark { border-color: rgba(0, 102, 255, 0.2); border-top-color: var(--primary); }
        .loader-box { display: flex; align-items: center; justify-content: center; gap: 12px; padding: 40px; color: var(--text-light); }
        @keyframes spin { to { transform: rotate(360deg); } }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
            font-size: 13px;
        }
        .status { display: flex; align-items: center; gap: 8px; color: var(--text-light); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); }
        .status-dot.online { background: var(--success); }
        .status-dot.offline { background: var(--error); }
        .link { color: var(--primary); text-decoration: none; font-weight: 500; }
        .link:hover { text-decoration: underline; }
        .hidden { display: none !important; }
        @media (max-width: 640px) {
            .page-wrapper { padding: 16px; align-items: flex-start; }
            .card { padding: 24px; }
            .title { font-size: 24px; }
            .tabs { overflow-x: auto; }
            .tab { padding: 8px 16px; font-size: 13px; white-space: nowrap; }
            .stats-table { font-size: 12px; }
            .stats-table th, .stats-table td { padding: 8px 4px; }
            .provider-item { flex-direction: column; align-items: flex-start; gap: 8px; }
            .model-select-row { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="page-wrapper">
        <div class="card">
            <h1 class="title">Free AI Selector</h1>
            <p class="subtitle">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –ª—É—á—à–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π AI –º–æ–¥–µ–ª–∏</p>

            <div class="tabs">
                <button class="tab active" data-tab="chat">–ß–∞—Ç</button>
                <button class="tab" data-tab="stats">–†–µ–π—Ç–∏–Ω–≥</button>
                <button class="tab" data-tab="test">–¢–µ—Å—Ç</button>
            </div>

            <div class="tab-content">
                <div id="chat" class="tab-pane active">
                    <textarea id="prompt-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å –∫ AI..." rows="4"></textarea>
                    <textarea id="system-prompt-input" placeholder="System prompt (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)" rows="3" maxlength="5000"></textarea>

                    <div class="format-selector">
                        <label class="format-label">–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="response-format" value="text" checked>
                                <span>–¢–µ–∫—Å—Ç</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="response-format" value="json">
                                <span>JSON</span>
                            </label>
                        </div>
                    </div>

                    <div class="model-selector">
                        <label class="format-label">–†–µ–∂–∏–º –º–æ–¥–µ–ª–∏:</label>
                        <div class="radio-group">
                            <label class="radio-option">
                                <input type="radio" name="model-mode" value="auto" checked>
                                <span>–ê–≤—Ç–æ</span>
                            </label>
                            <label class="radio-option">
                                <input type="radio" name="model-mode" value="manual">
                                <span>–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è</span>
                            </label>
                        </div>
                        <div id="model-select-wrapper" class="model-select-row hidden">
                            <select id="model-select" class="model-select" aria-label="–í—ã–±–æ—Ä AI –º–æ–¥–µ–ª–∏">
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>
                            </select>
                            <button id="refresh-models-btn" class="btn-icon" type="button" title="–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π">‚Üª</button>
                        </div>
                        <p class="model-help">–†—É—á–Ω–æ–π —Å–ø–∏—Å–æ–∫: —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Å score &gt; 0.4.</p>
                        <div id="model-error" class="error-box hidden"></div>
                    </div>

                    <button id="send-btn" class="btn-primary" onclick="sendPrompt()">
                        <span id="send-btn-text">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</span>
                        <span id="send-btn-loader" class="loader hidden"></span>
                    </button>
                    <div id="chat-response" class="response-box hidden">
                        <div class="response-meta">
                            <span id="response-model" class="tag"></span>
                            <span id="response-provider" class="tag tag-gray"></span>
                            <span id="response-time" class="tag tag-blue"></span>
                        </div>
                        <div id="response-text" class="response-text"></div>
                    </div>
                    <div id="chat-error" class="error-box hidden"></div>
                </div>

                <div id="stats" class="tab-pane hidden">
                    <div class="section-header">
                        <span class="section-title">–†–µ–π—Ç–∏–Ω–≥ –º–æ–¥–µ–ª–µ–π –ø–æ –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç–∏</span>
                        <button id="refresh-stats-btn" class="btn-icon" onclick="loadStats()" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>
                    </div>
                    <div id="stats-loader" class="loader-box hidden">
                        <span class="loader loader-dark"></span>
                        <span>–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <div id="stats-table-container">
                        <table class="stats-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>–ú–æ–¥–µ–ª—å</th>
                                    <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
                                    <th>Score</th>
                                    <th>–£—Å–ø–µ—Ö</th>
                                </tr>
                            </thead>
                            <tbody id="stats-tbody"></tbody>
                        </table>
                    </div>
                    <div id="stats-error" class="error-box hidden"></div>
                </div>

                <div id="test" class="tab-pane hidden">
                    <p class="hint">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—Å–µ—Ö AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤</p>
                    <button id="test-providers-btn" class="btn-primary" onclick="testProviders()">
                        <span id="test-btn-text">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ</span>
                        <span id="test-btn-loader" class="loader hidden"></span>
                    </button>
                    <div id="providers-results" class="providers-results hidden">
                        <div id="providers-summary" class="providers-summary"></div>
                        <div id="providers-list" class="providers-list"></div>
                    </div>
                    <div id="providers-error" class="error-box hidden"></div>
                </div>
            </div>

            <div class="card-footer">
                <span class="status">
                    <span id="status-icon" class="status-dot"></span>
                    <span id="status-text">–ü—Ä–æ–≤–µ—Ä–∫–∞...</span>
                </span>
                <a id="api-docs-link" href="/docs" class="link">API Docs</a>
            </div>
        </div>
    </div>

    <script>
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –±–∞–∑–æ–≤—ã–π –ø—É—Ç—å –¥–ª—è —Ä–∞–±–æ—Ç—ã –∑–∞ nginx-proxy
        // –ù–∞ VPS: API_BASE = '/free-ai-selector'
        // –õ–æ–∫–∞–ª—å–Ω–æ: API_BASE = ''
        const API_BASE = window.location.pathname.includes('/free-ai-selector/') ? '/free-ai-selector' : '';
        const MANUAL_MODEL_MIN_SCORE = 0.4;
        let manualModelsLoaded = false;

        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É API Docs –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –∑–∞ proxy
        document.addEventListener('DOMContentLoaded', () => {
            const apiDocsLink = document.getElementById('api-docs-link');
            if (apiDocsLink) {
                apiDocsLink.href = `${API_BASE}/docs`;
            }
        });

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                headers: { 'Content-Type': 'application/json', ...options.headers },
                ...options
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.detail || `–û—à–∏–±–∫–∞ API: ${response.status}`);
            return data;
        }

        function show(el) { el.classList.remove('hidden'); }
        function hide(el) { el.classList.add('hidden'); }
        function formatTime(s) { return s == null ? '‚Äî' : `${Number(s).toFixed(2)}—Å`; }
        function formatPercent(v) { return v == null ? '‚Äî' : `${(Number(v) * 100).toFixed(1)}%`; }
        function getMedal(r) { return r === 1 ? 'ü•á' : r === 2 ? 'ü•à' : r === 3 ? 'ü•â' : ''; }
        function escapeHtml(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
        function getCheckedValue(name) { return Array.from(document.getElementsByName(name)).find(r => r.checked)?.value; }

        function setAutoModeWithError(message) {
            const modelModeRadios = document.getElementsByName('model-mode');
            const autoRadio = Array.from(modelModeRadios).find(r => r.value === 'auto');
            const modelSelectWrapper = document.getElementById('model-select-wrapper');
            const modelSelect = document.getElementById('model-select');
            const modelError = document.getElementById('model-error');

            if (autoRadio) autoRadio.checked = true;
            hide(modelSelectWrapper);
            modelSelect.value = '';
            modelSelect.disabled = true;
            manualModelsLoaded = false;
            showError(modelError, `${message} –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –≤ —Ä–µ–∂–∏–º –ê–≤—Ç–æ.`);
        }

        async function loadManualModelOptions() {
            const modelSelect = document.getElementById('model-select');
            const modelError = document.getElementById('model-error');
            hide(modelError);

            modelSelect.disabled = true;
            modelSelect.innerHTML = '<option value="">–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...</option>';

            try {
                const data = await apiCall('/api/v1/models/stats');
                const models = (data.models || [])
                    .filter(model => model.is_active && Number(model.reliability_score) > MANUAL_MODEL_MIN_SCORE)
                    .sort((a, b) => Number(b.reliability_score || 0) - Number(a.reliability_score || 0));

                if (models.length === 0) {
                    modelSelect.innerHTML = '<option value="">–ù–µ—Ç –º–æ–¥–µ–ª–µ–π –≤—ã—à–µ –ø–æ—Ä–æ–≥–∞</option>';
                    setAutoModeWithError(`–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π —Å score > ${MANUAL_MODEL_MIN_SCORE}`);
                    return false;
                }

                modelSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å</option>';
                models.forEach(model => {
                    const score = Number(model.reliability_score || 0).toFixed(2);
                    const option = document.createElement('option');
                    option.value = String(model.id);
                    option.textContent = `${model.name || 'Unknown'} (${model.provider || 'Unknown'}) ‚Äî score: ${score}`;
                    modelSelect.appendChild(option);
                });
                modelSelect.disabled = false;
                manualModelsLoaded = true;
                return true;
            } catch (e) {
                modelSelect.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π</option>';
                setAutoModeWithError(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π: ${e.message}`);
                return false;
            }
        }

        function initModelSelector() {
            const modeRadios = document.getElementsByName('model-mode');
            const modelSelectWrapper = document.getElementById('model-select-wrapper');
            const refreshModelsBtn = document.getElementById('refresh-models-btn');
            const modelError = document.getElementById('model-error');

            const onModeChange = async () => {
                hide(modelError);
                const selectedMode = getCheckedValue('model-mode') || 'auto';

                if (selectedMode === 'manual') {
                    show(modelSelectWrapper);
                    if (!manualModelsLoaded) {
                        await loadManualModelOptions();
                    }
                    return;
                }

                hide(modelSelectWrapper);
            };

            modeRadios.forEach(radio => radio.addEventListener('change', () => { void onModeChange(); }));

            refreshModelsBtn.addEventListener('click', async () => {
                if ((getCheckedValue('model-mode') || 'auto') !== 'manual') return;
                manualModelsLoaded = false;
                await loadManualModelOptions();
            });
        }

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const panes = document.querySelectorAll('.tab-pane');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetId = tab.dataset.tab;
                    tabs.forEach(t => t.classList.remove('active'));
                    panes.forEach(p => { p.classList.remove('active'); p.classList.add('hidden'); });
                    tab.classList.add('active');
                    const targetPane = document.getElementById(targetId);
                    if (targetPane) { targetPane.classList.add('active'); targetPane.classList.remove('hidden'); }
                    if (targetId === 'stats') loadStats();
                });
            });
        }

        async function sendPrompt() {
            const input = document.getElementById('prompt-input');
            const systemPromptInput = document.getElementById('system-prompt-input');
            const formatRadios = document.getElementsByName('response-format');
            const modelModeRadios = document.getElementsByName('model-mode');
            const modelSelect = document.getElementById('model-select');
            const sendBtn = document.getElementById('send-btn');
            const sendBtnText = document.getElementById('send-btn-text');
            const sendBtnLoader = document.getElementById('send-btn-loader');
            const responseBox = document.getElementById('chat-response');
            const errorBox = document.getElementById('chat-error');
            const modelError = document.getElementById('model-error');

            const prompt = input.value.trim();
            if (!prompt) { showError(errorBox, '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞'); return; }
            hide(modelError);

            // –°–æ–±—Ä–∞—Ç—å payload
            const payload = { prompt };

            // –î–æ–±–∞–≤–∏—Ç—å system_prompt –µ—Å–ª–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω
            const systemPrompt = systemPromptInput.value.trim();
            if (systemPrompt) {
                if (systemPrompt.length > 5000) {
                    showError(errorBox, 'System prompt –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 5000 —Å–∏–º–≤–æ–ª–æ–≤');
                    return;
                }
                payload.system_prompt = systemPrompt;
            }

            // –î–æ–±–∞–≤–∏—Ç—å response_format –µ—Å–ª–∏ JSON –≤—ã–±—Ä–∞–Ω
            const selectedFormat = Array.from(formatRadios).find(r => r.checked)?.value;
            if (selectedFormat === 'json') {
                payload.response_format = { type: "json_object" };
            }

            // –î–æ–±–∞–≤–∏—Ç—å model_id –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ
            let selectedModelMode = Array.from(modelModeRadios).find(r => r.checked)?.value || 'auto';
            if (selectedModelMode === 'manual') {
                if (!manualModelsLoaded) {
                    const loaded = await loadManualModelOptions();
                    if (!loaded) selectedModelMode = 'auto';
                }

                if (selectedModelMode === 'manual') {
                    const selectedModelId = Number.parseInt(modelSelect.value, 10);
                    if (Number.isNaN(selectedModelId) || selectedModelId <= 0) {
                        showError(errorBox, '–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –∏–ª–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç–µ—Å—å –≤ —Ä–µ–∂–∏–º –ê–≤—Ç–æ.');
                        return;
                    }
                    payload.model_id = selectedModelId;
                }
            }

            sendBtn.disabled = true; hide(sendBtnText); show(sendBtnLoader); hide(responseBox); hide(errorBox);
            try {
                const data = await apiCall('/api/v1/prompts/process', { method: 'POST', body: JSON.stringify(payload) });
                document.getElementById('response-model').textContent = data.selected_model || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('response-provider').textContent = data.provider || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('response-time').textContent = formatTime(data.response_time_seconds);
                document.getElementById('response-text').textContent = data.response || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
                show(responseBox);
            } catch (e) { showError(errorBox, e.message); }
            finally { sendBtn.disabled = false; show(sendBtnText); hide(sendBtnLoader); }
        }

        async function loadStats() {
            const tbody = document.getElementById('stats-tbody');
            const loader = document.getElementById('stats-loader');
            const tableContainer = document.getElementById('stats-table-container');
            const errorBox = document.getElementById('stats-error');
            const refreshBtn = document.getElementById('refresh-stats-btn');
            show(loader); hide(tableContainer); hide(errorBox);
            if (refreshBtn) refreshBtn.style.animation = 'spin 0.8s linear infinite';
            try {
                const data = await apiCall('/api/v1/models/stats');
                tbody.innerHTML = '';
                const models = (data.models || []).sort((a, b) => (b.reliability_score || 0) - (a.reliability_score || 0));
                models.forEach((model, i) => {
                    const rank = i + 1;
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="rank-cell"><span class="medal">${getMedal(rank)}</span>${rank > 3 ? rank : ''}</td>
                        <td>${escapeHtml(model.name || '‚Äî')}</td>
                        <td>${escapeHtml(model.provider || '‚Äî')}</td>
                        <td class="score-cell">${model.reliability_score?.toFixed(2) || '‚Äî'}</td>
                        <td>${formatPercent(model.success_rate)}</td>
                    `;
                    tbody.appendChild(row);
                });
                if (models.length === 0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#666;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                show(tableContainer);
            } catch (e) { showError(errorBox, e.message); }
            finally { hide(loader); if (refreshBtn) refreshBtn.style.animation = ''; }
        }

        async function testProviders() {
            const testBtn = document.getElementById('test-providers-btn');
            const testBtnText = document.getElementById('test-btn-text');
            const testBtnLoader = document.getElementById('test-btn-loader');
            const resultsContainer = document.getElementById('providers-results');
            const summaryDiv = document.getElementById('providers-summary');
            const listDiv = document.getElementById('providers-list');
            const errorBox = document.getElementById('providers-error');
            testBtn.disabled = true; hide(testBtnText); show(testBtnLoader); hide(resultsContainer); hide(errorBox);
            try {
                const data = await apiCall('/api/v1/providers/test', { method: 'POST' });
                summaryDiv.innerHTML = `<span style="color:var(--success);">‚úì ${data.successful || 0}</span> / <span style="color:var(--error);">‚úó ${data.failed || 0}</span> –∏–∑ ${data.total_providers || 0} –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤`;
                listDiv.innerHTML = '';
                (data.results || []).forEach(r => {
                    const ok = r.status === 'success';
                    const item = document.createElement('div');
                    item.className = `provider-item ${ok ? 'success' : 'error'}`;
                    item.innerHTML = `
                        <div class="provider-info"><span class="provider-name">${escapeHtml(r.provider || '‚Äî')}</span><span class="provider-model">${escapeHtml(r.model || '‚Äî')}</span></div>
                        <div class="provider-status">${ok ? `<span style="color:var(--success);">‚úì</span><span class="provider-time">${formatTime(r.response_time)}</span>` : `<span style="color:var(--error);">‚úó</span><span class="provider-error" title="${escapeHtml(r.error || '')}">${escapeHtml(r.error || '–û—à–∏–±–∫–∞')}</span>`}</div>
                    `;
                    listDiv.appendChild(item);
                });
                show(resultsContainer);
            } catch (e) { showError(errorBox, e.message); }
            finally { testBtn.disabled = false; show(testBtnText); hide(testBtnLoader); }
        }

        async function checkHealth() {
            const statusIcon = document.getElementById('status-icon');
            const statusText = document.getElementById('status-text');
            try {
                const data = await apiCall('/health');
                if (data.status === 'healthy') { statusIcon.className = 'status-dot online'; statusText.textContent = '–û–Ω–ª–∞–π–Ω'; }
                else { statusIcon.className = 'status-dot offline'; statusText.textContent = '–ü—Ä–æ–±–ª–µ–º—ã'; }
            } catch (e) { statusIcon.className = 'status-dot offline'; statusText.textContent = '–û—Ñ—Ñ–ª–∞–π–Ω'; }
        }

        function showError(box, msg) { box.textContent = msg; show(box); }

        function init() { initTabs(); initModelSelector(); checkHealth(); setInterval(checkHealth, 30000); }

        document.addEventListener('DOMContentLoaded', init);
        document.addEventListener('DOMContentLoaded', () => {
            const input = document.getElementById('prompt-input');
            if (input) input.addEventListener('keydown', e => { if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') sendPrompt(); });
        });
    </script>
</body>
</html>
